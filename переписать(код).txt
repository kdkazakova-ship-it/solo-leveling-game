<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прокачка персонажа в реальной жизни</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap">
    <style>
        :root {
            --primary: #6a11cb;
            --secondary: #2575fc;
            --accent: #00c9ff;
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #f0f0f0;
            --success: #00c853;
            --warning: #ffab00;
            --danger: #ff1744;
            --card-bg: rgba(30, 30, 46, 0.7);
            --progress-bg: rgba(255, 255, 255, 0.1);
            --glow: 0 0 10px rgba(0, 201, 255, 0.5);
            --weekly-quest-glow: 0 0 15px rgba(255, 165, 0, 0.7);
            --mandatory-quest: rgba(255, 50, 50, 0.3);
            --sunday-bonus: rgba(255, 215, 0, 0.2);
            --gold: #ffd700;
            --coin-color: #ffd700;
            --common: #9e9e9e;
            --rare: #2196f3;
            --epic: #9c27b0;
            --legendary: #ff5722;
        }

        /* Аниме-пиксельная тема вместо фиолетовой */
        body.light-theme {
            --primary: #ff6b8b;
            --secondary: #4ecdc4;
            --accent: #45b7d1;
            --dark: #1a1a2e;
            --darker: #16213e;
            --light: #f9f9f9;
            --card-bg: rgba(255, 255, 255, 0.9);
            --progress-bg: rgba(26, 26, 46, 0.2);
            --glow: 0 0 15px rgba(255, 107, 139, 0.6);
            --weekly-quest-glow: 0 0 20px rgba(78, 205, 196, 0.7);
            --mandatory-quest: rgba(255, 107, 139, 0.3);
            --sunday-bonus: rgba(255, 215, 0, 0.3);
            --border-color: rgba(26, 26, 46, 0.1);
            --pixel-shadow: 4px 4px 0 rgba(0, 0, 0, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker), var(--dark));
            color: var(--light);
            min-height: 100vh;
            padding: 12px;
            overflow-x: hidden;
            position: relative;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .light-theme body {
            background: linear-gradient(135deg, #0f3460, #1a1a2e);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 107, 139, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(78, 205, 196, 0.1) 0%, transparent 20%);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }
        
        .watermark {
            position: fixed;
            bottom: 12px;
            right: 12px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.3);
            z-index: 1;
        }
        
        .watermark a {
            color: rgba(255, 255, 255, 0.4);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .watermark a:hover {
            color: var(--accent);
            text-decoration: underline;
        }
        
        /* Переключатель темы */
        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--card-bg);
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 2px solid var(--border-color, rgba(255, 255, 255, 0.1));
            transition: all 0.3s ease;
        }

        .light-theme .theme-toggle {
            border: 2px solid rgba(26, 26, 46, 0.2);
            box-shadow: var(--pixel-shadow);
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--glow);
        }
        
        .theme-toggle i {
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Кнопка поддержки автора */
        .support-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .light-theme .support-btn {
            box-shadow: var(--pixel-shadow);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .support-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .support-btn i {
            font-size: 1.2rem;
        }
        
        header {
            text-align: center;
            padding: 30px 15px;
            margin-bottom: 25px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(100, 100, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .light-theme header {
            border: 2px solid rgba(255, 107, 139, 0.3);
            box-shadow: var(--pixel-shadow);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 12px;
            letter-spacing: 1px;
            text-shadow: 0 2px 6px rgba(0,0,0,0.6);
            color: var(--accent);
            position: relative;
        }

        .light-theme h1 {
            color: #ff6b8b;
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 4px;
            background: var(--accent);
            border-radius: 2px;
        }

        .light-theme h1::after {
            background: linear-gradient(90deg, #ff6b8b, #4ecdc4);
        }
        
        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 25px;
            opacity: 0.9;
        }
        
        .btn {
            background: linear-gradient(to right, var(--accent), #0095ff);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
            box-shadow: 0 4px 15px rgba(0, 201, 255, 0.4);
            display: inline-block;
            min-width: 220px;
            margin: 5px;
            font-weight: bold;
        }

        .light-theme .btn {
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--pixel-shadow);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: 0.5s;
            z-index: -1;
        }
        
        .btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 201, 255, 0.6);
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .light-theme .section {
            border: 2px solid rgba(255, 107, 139, 0.2);
            box-shadow: var(--pixel-shadow);
        }
        
        .section.sunday {
            background: var(--sunday-bonus);
            border: 2px solid gold;
            animation: sunday-pulse 3s infinite;
        }
        
        .section-title {
            font-size: 1.6rem;
            margin-bottom: 18px;
            text-align: center;
            color: var(--accent);
            position: relative;
            padding-bottom: 10px;
        }

        .light-theme .section-title {
            color: #4ecdc4;
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.2);
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 2px;
        }
        
        .level-container {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            cursor: pointer;
        }
        
        .level {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            background: linear-gradient(to right, #ff8a00, #ff0080);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: pulse 2s infinite;
        }
        
        .level-tooltip {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .level-container:hover .level-tooltip {
            opacity: 1;
        }
        
        .level-progress-container {
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 100%;
            margin: 0 auto 10px;
        }
        
        .level-progress-bar-container {
            flex: 1;
            background: var(--progress-bg);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            max-width: 400px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .light-theme .level-progress-bar-container {
            border: 2px solid rgba(26, 26, 46, 0.2);
        }
        
        .level-progress-bar {
            height: 100%;
            border-radius: 10px;
            background: linear-gradient(to right, #ff8a00, #ff0080);
            transition: width 0.5s ease;
        }
        
        .attributes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .attribute-card {
            background: rgba(20, 20, 40, 0.7);
            border-radius: 15px;
            padding: 16px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid rgba(100, 100, 255, 0.2);
            position: relative;
            cursor: pointer;
        }

        .light-theme .attribute-card {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255, 107, 139, 0.3);
            box-shadow: var(--pixel-shadow);
            color: #1a1a2e;
        }
        
        .attribute-card.highlight {
            animation: highlight 1.5s ease-out;
        }
        
        .attribute-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--glow);
        }
        
        .attribute-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .attribute-name {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .attribute-value {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .light-theme .attribute-value {
            color: #1a1a2e;
        }
        
        .progress-container {
            background: var(--progress-bg);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-theme .progress-container {
            border: 1px solid rgba(26, 26, 46, 0.2);
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        
        .strength .progress-bar { background: linear-gradient(to right, #ff416c, #ff4b2b); }
        .agility .progress-bar { background: linear-gradient(to right, #56ab2f, #a8e063); }
        .perception .progress-bar { background: linear-gradient(to right, #2193b0, #6dd5ed); }
        .stamina .progress-bar { background: linear-gradient(to right, #834d9b, #d04ed6); }
        .intelligence .progress-bar { background: linear-gradient(to right, #00c9ff, #92fe9d); }
        
        .achievements-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            justify-content: center;
        }
        
        .achievement-card {
            background: rgba(20, 20, 40, 0.7);
            border-radius: 15px;
            padding: 18px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid rgba(100, 100, 255, 0.2);
            cursor: pointer;
            position: relative;
        }

        .light-theme .achievement-card {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(78, 205, 196, 0.3);
            box-shadow: var(--pixel-shadow);
            color: #1a1a2e;
        }
        
        .achievement-card.locked {
            filter: grayscale(1) brightness(0.5);
        }
        
        .achievement-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--glow);
        }
        
        .achievement-icon {
            font-size: 2.2rem;
            margin-bottom: 15px;
            color: var(--warning);
        }
        
        .achievement-title {
            font-size: 1.15rem;
            margin-bottom: 8px;
            color: var(--accent);
        }
        
        .achievement-desc {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        
        .achievement-progress {
            height: 8px;
            background: var(--progress-bg);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-theme .achievement-progress {
            border: 1px solid rgba(26, 26, 46, 0.2);
        }
        
        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(to right, #ff8a00, #ff0080);
        }
        
        .locked-label {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            color: var(--warning);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .quests-section {
            scroll-margin-top: 70px;
        }
        
        .quests-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .quests-title-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .replace-quest-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--accent);
            width: 38px;
            height: 38px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        
        .replace-quest-btn:hover {
            background: var(--accent);
            color: white;
            transform: rotate(90deg);
        }
        
        .replace-quest-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        /* NEW: Кнопка добавления своего квеста */
        .add-custom-quest-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--accent);
            width: 38px;
            height: 38px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        
        .add-custom-quest-btn:hover {
            background: var(--accent);
            color: white;
            transform: scale(1.1);
        }
        
        .quests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
        }
        
        .quest-card {
            background: rgba(20, 20, 40, 0.7);
            border-radius: 15px;
            padding: 16px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(100, 100, 255, 0.2);
            transition: all 0.3s ease;
        }

        .light-theme .quest-card {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(69, 183, 209, 0.3);
            box-shadow: var(--pixel-shadow);
            color: #1a1a2e;
        }
        
        .mandatory-quest {
            background: var(--mandatory-quest);
            border: 2px solid rgba(255, 50, 50, 0.6);
        }

        .custom-quest {
            background: rgba(138, 43, 226, 0.3);
            border: 2px solid rgba(186, 85, 211, 0.6);
        }
        
        .quest-card.completed {
            animation: fadeOut 0.5s forwards;
        }
        
        .quest-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--glow);
        }
        
        .quest-title {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--accent);
            font-weight: bold;
        }

        .light-theme .quest-title {
            color: #45b7d1;
        }
        
        .mandatory-label {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .custom-label {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .quest-desc {
            font-size: 0.9rem;
            margin-bottom: 12px;
            opacity: 0.9;
        }
        
        .quest-reward {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
            font-weight: bold;
            color: var(--success);
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .quest-btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .light-theme .quest-btn {
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
        }
        
        .quest-btn:hover {
            transform: scale(1.03);
            box-shadow: 0 0 8px rgba(37, 117, 252, 0.7);
        }
        
        .quest-btn.completed {
            background: var(--success);
            cursor: default;
        }
        
        .timer {
            text-align: center;
            margin-top: 20px;
            font-size: 1rem;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .light-theme .timer {
            border: 2px solid rgba(26, 26, 46, 0.2);
            background: rgba(255, 255, 255, 0.9);
            color: #1a1a2e;
        }
        
        .timer span {
            color: var(--accent);
            font-weight: bold;
        }
        
        .weekly-quest-section {
            margin-top: 30px;
        }
        
        .weekly-quest-card {
            background: rgba(40, 30, 60, 0.8);
            border-radius: 20px;
            padding: 20px;
            position: relative;
            border: 2px solid var(--warning);
            transition: all 0.3s ease;
        }

        .light-theme .weekly-quest-card {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255, 171, 0, 0.8);
            box-shadow: var(--pixel-shadow);
            color: #1a1a2e;
        }
        
        .weekly-quest-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--weekly-quest-glow);
        }
        
        .weekly-quest-title {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: var(--warning);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .weekly-quest-title i {
            font-size: 1.8rem;
        }
        
        .weekly-quest-desc {
            font-size: 1rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .weekly-quest-reward {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 15px;
            font-weight: bold;
            color: var(--warning);
            font-size: 1.1rem;
            white-space: nowrap;
        }
        
        .weekly-quest-btn {
            background: linear-gradient(to right, #ff8a00, #ff4b2b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: bold;
            font-size: 1rem;
        }

        .light-theme .weekly-quest-btn {
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
        }
        
        .weekly-quest-btn:hover {
            transform: scale(1.03);
            box-shadow: 0 0 12px rgba(255, 140, 0, 0.7);
        }
        
        .weekly-quest-btn.completed {
            background: var(--success);
            cursor: default;
        }
        
        .weekly-timer {
            text-align: center;
            margin-top: 20px;
            font-size: 1.1rem;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 2px solid var(--warning);
        }

        .light-theme .weekly-timer {
            border: 2px solid rgba(255, 171, 0, 0.8);
            background: rgba(255, 255, 255, 0.9);
            color: #1a1a2e;
        }
        
        .weekly-timer span {
            color: var(--warning);
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--darker);
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .light-theme .modal-content {
            background: rgba(255, 255, 255, 0.95);
            color: #1a1a2e;
            border: 2px solid rgba(255, 107, 139, 0.3);
            box-shadow: var(--pixel-shadow);
        }
        
        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.3rem;
            cursor: pointer;
        }
        
        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--accent);
        }
        
        .modal-text {
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .modal-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 20px 0;
        }
        
        .modal-option {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--light);
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .modal-option:hover {
            background: var(--accent);
            color: var(--dark);
        }

        /* NEW: Стили для формы создания квеста */
        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            text-align: left;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-label {
            font-weight: bold;
            color: var(--accent);
        }
        
        .form-input, .form-textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            color: var(--light);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .light-theme .form-input,
        .light-theme .form-textarea {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(26, 26, 46, 0.2);
            color: #1a1a2e;
        }
        
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 5px var(--accent);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .status-indicator {
            display: inline-block;
            background: linear-gradient(to right, #ff8a00, #ff0080);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 8px;
            font-weight: bold;
        }
        
        .profession-indicator {
            display: inline-block;
            background: linear-gradient(to right, #00c9ff, #92fe9d);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 8px;
            font-weight: bold;
            color: var(--dark);
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            margin-top: 25px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
        }
        
        .copyright {
            margin-top: 8px;
        }
        
        .copyright a {
            color: var(--accent);
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .copyright a:hover {
            text-decoration: underline;
        }
        
        .sunday-notice {
            background: linear-gradient(45deg, #ffd700, #ff8c00);
            color: #000;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            animation: sunday-pulse 3s infinite;
            border: 2px solid gold;
        }
        
        .completed-all {
            background: rgba(0, 200, 83, 0.2);
            border: 2px solid var(--success);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            animation: fadeIn 0.5s;
        }
        
        .week-report {
            background: rgba(0, 201, 255, 0.2);
            border: 2px solid var(--accent);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .week-report h3 {
            color: var(--accent);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .week-report ul {
            list-style-type: none;
            padding: 0;
        }
        
        .week-report li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }
        
        .week-report li::before {
            content: "•";
            color: var(--accent);
            position: absolute;
            left: 0;
        }
        
        .glowing {
            animation: progress-glow 1.5s infinite alternate;
        }
        
        .rotating {
            animation: rotate 1s ease-out;
        }
        
        .replace-mode .quest-card {
            cursor: pointer;
            transform: scale(0.98);
        }
        
        .replace-mode .quest-card:hover {
            transform: scale(1);
            box-shadow: 0 0 15px var(--warning);
        }
        
        .coin {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #ffd700, #ff9800);
            border-radius: 50%;
            margin-left: 5px;
            font-weight: bold;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
        }
        
        .coin-icon {
            color: var(--coin-color);
            font-weight: bold;
            margin: 0 2px;
            white-space: nowrap;
        }
        
        .wallet {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(30, 30, 46, 0.8);
            border-radius: 20px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            z-index: 10;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            cursor: pointer;
        }

        .light-theme .wallet {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255, 215, 0, 0.5);
            box-shadow: var(--pixel-shadow);
            color: #1a1a2e;
        }
        
        .coin-tooltip {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .wallet:hover .coin-tooltip {
            opacity: 1;
        }
        
        .shop-section {
            margin-top: 30px;
        }
        
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        
        .shop-item {
            background: rgba(30, 30, 50, 0.8);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid rgba(100, 100, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .light-theme .shop-item {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(69, 183, 209, 0.3);
            box-shadow: var(--pixel-shadow);
            color: #1a1a2e;
        }
        
        .shop-item.common {
            border: 2px solid var(--common);
        }
        
        .shop-item.rare {
            border: 2px solid var(--rare);
        }
        
        .shop-item.epic {
            border: 2px solid var(--epic);
        }
        
        .shop-item.legendary {
            border: 2px solid var(--legendary);
        }
        
        .shop-item.common:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(158, 158, 158, 0.4);
        }
        
        .shop-item.rare:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.6);
        }
        
        .shop-item.epic:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.8);
        }
        
        .shop-item.legendary:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(255, 87, 34, 0.9);
        }
        
        .god-discipline {
            animation: god-glow 2s infinite;
            border: 2px solid gold;
            background: rgba(255, 215, 0, 0.1);
        }
        
        /* Chest glow animations */
        @keyframes common-glow {
            0% { box-shadow: 0 0 5px var(--common); }
            50% { box-shadow: 0 0 10px var(--common); }
            100% { box-shadow: 0 0 5px var(--common); }
        }
        
        @keyframes rare-glow {
            0% { box-shadow: 0 0 5px var(--rare); }
            50% { box-shadow: 0 0 15px var(--rare); }
            100% { box-shadow: 0 0 5px var(--rare); }
        }
        
        @keyframes epic-glow {
            0% { box-shadow: 0 0 5px var(--epic); }
            50% { box-shadow: 0 0 20px var(--epic); }
            100% { box-shadow: 0 0 5px var(--epic); }
        }
        
        @keyframes legendary-glow {
            0% { box-shadow: 0 0 5px var(--legendary); }
            50% { box-shadow: 0 0 25px var(--legendary); }
            100% { box-shadow: 0 0 5px var(--legendary); }
        }
        
        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        
        @keyframes progress-glow {
            0% { box-shadow: 0 0 5px var(--accent); }
            100% { box-shadow: 0 0 15px var(--accent); }
        }
        
        @keyframes highlight {
            0% { box-shadow: 0 0 0 0 rgba(0, 201, 255, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(0, 201, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 201, 255, 0); }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-15px); }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes sunday-pulse {
            0% { box-shadow: 0 0 5px gold; }
            50% { box-shadow: 0 0 20px gold; }
            100% { box-shadow: 0 0 5px gold; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes coin-spin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }
        
        @keyframes god-glow {
            0% { box-shadow: 0 0 5px gold, 0 0 10px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px gold, 0 0 30px rgba(255, 215, 0, 0.8); }
            100% { box-shadow: 0 0 5px gold, 0 0 10px rgba(255, 215, 0, 0.5); }
        }
        
        @keyframes fly-coin {
            0% { 
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            80% {
                opacity: 0.8;
            }
            100% { 
                transform: translate(var(--tx), var(--ty)) scale(0.1);
                opacity: 0;
            }
        }
        
        @keyframes level-up {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); text-shadow: 0 0 20px var(--accent); }
            100% { transform: scale(1); }
        }
        
        @keyframes chest-open {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes float-coin {
            0% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }
        
        /* NEW: Notification system */
        #notifications-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }
        
        .notification {
            background: rgba(30, 30, 46, 0.9);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border-left: 4px solid var(--accent);
            transform: translateX(100%);
            animation: slideIn 0.3s forwards, fadeOut 0.5s forwards 3s;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .light-theme .notification {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255, 107, 139, 0.3);
            box-shadow: var(--pixel-shadow);
            color: #1a1a2e;
        }
        
        .notification.success {
            border-left-color: var(--success);
        }
        
        .notification.warning {
            border-left-color: var(--warning);
        }
        
        .notification.danger {
            border-left-color: var(--danger);
        }
        
        .notification.info {
            border-left-color: var(--accent);
        }
        
        .notification .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .notification .notification-content {
            font-size: 0.9rem;
        }
        
        @keyframes slideIn {
            to { transform: translateX(0); }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; }
        }
        
        /* NEW: Event feed */
        #events-section {
            margin-top: 30px;
        }
        
        .events-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(20, 20, 40, 0.5);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .light-theme .events-list {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(26, 26, 46, 0.2);
            color: #1a1a2e;
        }
        
        .event-item {
            padding: 12px;
            background: rgba(30, 30, 50, 0.7);
            border-radius: 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 3px solid var(--accent);
            animation: fadeIn 0.3s;
        }

        .light-theme .event-item {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(69, 183, 209, 0.2);
        }
        
        .event-item.success {
            border-left-color: var(--success);
        }
        
        .event-item.warning {
            border-left-color: var(--warning);
        }
        
        .event-item.danger {
            border-left-color: var(--danger);
        }
        
        .event-item .event-icon {
            font-size: 1.2rem;
            min-width: 25px;
            text-align: center;
        }
        
        .event-item .event-content {
            flex: 1;
        }
        
        .event-item .event-time {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        /* NEW: 2D Chests */
        .chest-icon {
            font-size: 3.5rem;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
        }
        
        .shop-item:hover .chest-icon {
            transform: translateY(-5px);
            animation: float-coin 1.5s infinite;
        }
        
        .chest-opening {
            animation: chest-open 0.5s ease-out;
        }
        
        .chest-coins {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            color: var(--coin-color);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .shop-item:hover .chest-coins {
            opacity: 1;
        }
        
        .chest-coins .coin-float {
            position: absolute;
            animation: float-coin 2s infinite;
        }
        
        .chest-coins .coin-float:nth-child(1) { 
            top: -20px; 
            left: -10px; 
            animation-delay: 0s; 
        }
        .chest-coins .coin-float:nth-child(2) { 
            top: -25px; 
            left: 10px; 
            animation-delay: 0.2s; 
        }
        .chest-coins .coin-float:nth-child(3) { 
            top: 0px; 
            left: -15px; 
            animation-delay: 0.4s; 
        }
        .chest-coins .coin-float:nth-child(4) { 
            top: 5px; 
            left: 15px; 
            animation-delay: 0.6s; 
        }

        /* NEW: Система регистрации */
        .login-modal {
            display: flex;
        }

        .login-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .login-input {
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--accent);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .light-theme .login-input {
            background: rgba(255, 255, 255, 0.9);
            color: #1a1a2e;
            border: 2px solid rgba(69, 183, 209, 0.8);
        }

        .login-input:focus {
            outline: none;
            box-shadow: 0 0 10px var(--accent);
        }

        .login-help {
            font-size: 0.9rem;
            opacity: 0.8;
            text-align: center;
            margin-top: 10px;
        }

        .user-info {
            position: fixed;
            top: 90px;
            right: 20px;
            background: var(--card-bg);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            z-index: 10;
            border: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .light-theme .user-info {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255, 107, 139, 0.3);
            color: #1a1a2e;
        }

        .user-id {
            font-weight: bold;
            color: var(--accent);
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            color: var(--warning);
        }

        @media (max-width: 1200px) {
            .achievements-container {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.9rem;
            }
            
            .subtitle {
                font-size: 1.1rem;
            }
            
            .section {
                padding: 18px 12px;
            }
            
            .attributes-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
            
            .quests-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 20px 15px;
            }
            
            .replace-quest-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .add-custom-quest-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            .btn {
                min-width: 180px;
                padding: 10px 20px;
                font-size: 1rem;
            }
            
            .weekly-quest-title {
                font-size: 1.2rem;
            }
            
            .weekly-quest-desc {
                font-size: 0.95rem;
            }
            
            .achievement-card {
                padding: 14px;
            }
            
            .shop-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
            
            .theme-toggle {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
            
            .theme-toggle i {
                font-size: 1.2rem;
            }

            .user-info {
                top: 80px;
                right: 10px;
                font-size: 0.8rem;
                padding: 8px 12px;
            }

            .support-btn {
                bottom: 10px;
                left: 10px;
                padding: 10px 15px;
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.7rem;
            }
            
            .level {
                font-size: 1.8rem;
            }
            
            .section-title {
                font-size: 1.4rem;
            }
            
            .attribute-name {
                font-size: 1.1rem;
            }
            
            .attribute-value {
                font-size: 1.3rem;
            }
            
            .quests-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .quest-card {
                padding: 14px;
            }

            .quests-title-container {
                flex-wrap: wrap;
            }
            
            .timer {
                font-size: 0.9rem;
                padding: 8px;
            }
            
            .achievement-card {
                padding: 12px;
            }
            
            .attribute-card {
                padding: 12px;
            }
            
            .quest-title {
                font-size: 1rem;
            }
            
            .quest-desc {
                font-size: 0.85rem;
            }
            
            .quest-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .weekly-quest-title {
                font-size: 1.1rem;
            }
            
            .weekly-quest-desc {
                font-size: 0.9rem;
            }
            
            .wallet {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 360px) {
            body {
                padding: 8px;
                font-size: 15px;
            }
            
            .btn {
                min-width: 160px;
                padding: 8px 16px;
            }
            
            .section-title {
                font-size: 1.3rem;
            }
            
            .level {
                font-size: 1.6rem;
            }
            
            .attribute-name {
                font-size: 1rem;
            }
            
            .attribute-value {
                font-size: 1.2rem;
            }
            
            .quest-card {
                padding: 12px;
            }
            
            .section {
                padding: 15px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="watermark">Создано <a href="https://www.instagram.com/_lap_tev_?igsh=azZhN3I0Yzd4MmZt&utm_source=qr" target="_blank">LAPTEV</a></div>
    
    <!-- Переключатель темы -->
    <div class="theme-toggle" id="theme-toggle">
        <i class="fas fa-moon"></i>
    </div>

    <!-- Кнопка поддержки автора -->
    <a href="https://www.donationalerts.com/r/lap_tev" target="_blank" class="support-btn">
        <i class="fas fa-heart"></i>
        Поддержать автора
    </a>
    
    <!-- NEW: Notifications container -->
    <div id="notifications-container"></div>
    
    <!-- NEW: Информация о пользователе -->
    <div class="user-info" id="user-info" style="display: none;">
        <i class="fas fa-user"></i>
        <span>ID: <span class="user-id" id="user-id-display"></span></span>
        <button class="logout-btn" id="logout-btn" title="Выйти">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>
    
    <div class="wallet" id="wallet">
        <i class="fas fa-coins" style="color: gold;"></i>
        <span id="coins">0</span> L
        <div class="coin-tooltip">Внутриигровая валюта для покупки сундуков</div>
    </div>
    
    <div class="container">
        <!-- Header section -->
        <header>
            <h1>Прокачка персонажа в реальной жизни</h1>
            <p class="subtitle">Стань лучшей версией себя через игровую механику</p>
            <button id="start-btn" class="btn">Начать прокачку</button>
        </header>
        
        <!-- Воскресное уведомление -->
        <div id="sunday-notice" class="sunday-notice" style="display: none;">
            <i class="fas fa-star"></i> Сегодня воскресенье! Все награды и штрафы увеличены вдвое <i class="fas fa-star"></i>
        </div>
        
        <!-- Еженедельный отчет -->
        <div id="week-report" class="week-report" style="display: none;">
            <h3>Ваш недельный отчет</h3>
            <div id="week-report-content"></div>
        </div>
        
        <!-- Stats section -->
        <section id="stats-section" class="section">
            <h2 class="section-title">Уровень и Характеристики</h2>
            
            <div class="level-container" id="level-container">
                <div id="level" class="level">Уровень 1</div>
                <div class="level-tooltip">Нажмите, чтобы узнать прогресс</div>
                <div class="level-progress-container">
                    <div class="level-progress-bar-container" id="level-progress-container">
                        <div id="level-progress-bar" class="level-progress-bar" style="width: 0%;"></div>
                    </div>
                </div>
                <div id="status-indicator" class="status-indicator" style="display: none;"></div>
                <div id="profession-indicator" class="profession-indicator" style="display: none;"></div>
            </div>
            
            <div class="attributes-grid">
                <div id="strength-card" class="attribute-card strength">
                    <div class="attribute-icon">
                        <i class="fas fa-dumbbell"></i>
                    </div>
                    <div class="attribute-name">Сила</div>
                    <div class="attribute-value">1 / 500</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: 0.2%;"></div>
                    </div>
                </div>
                
                <div id="agility-card" class="attribute-card agility">
                    <div class="attribute-icon">
                        <i class="fas fa-running"></i>
                    </div>
                    <div class="attribute-name">Ловкость</div>
                    <div class="attribute-value">1 / 500</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: 0.2%;"></div>
                    </div>
                </div>
                
                <div id="perception-card" class="attribute-card perception">
                    <div class="attribute-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="attribute-name">Восприятие</div>
                    <div class="attribute-value">1 / 500</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: 0.2%;"></div>
                    </div>
                </div>
                
                <div id="stamina-card" class="attribute-card stamina">
                    <div class="attribute-icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="attribute-name">Выносливость</div>
                    <div class="attribute-value">1 / 500</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: 0.2%;"></div>
                    </div>
                </div>
                
                <div id="intelligence-card" class="attribute-card intelligence">
                    <div class="attribute-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="attribute-name">Интеллект</div>
                    <div class="attribute-value">1 / 500</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: 0.2%;"></div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Achievements section -->
        <section class="section">
            <h2 class="section-title">Достижения</h2>
            
            <div class="achievements-container">
                <!-- Правила прокачки (заменено Дисциплину) -->
                <div class="achievement-card" id="rules-achievement">
                    <div class="achievement-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="achievement-title">Правила прокачки</div>
                    <div class="achievement-desc" id="rules-desc">
                        Нажмите, чтобы прочитать правила платформы
                    </div>
                </div>
                
                <!-- Status achievement -->
                <div class="achievement-card locked" id="status-achievement">
                    <div class="achievement-icon">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div class="achievement-title">Статус</div>
                    <div class="achievement-desc">
                        Доступен на 50 уровне. Выберите свой уникальный статус.
                    </div>
                    <div class="locked-label">50 УР</div>
                </div>
                
                <!-- Profession achievement -->
                <div class="achievement-card locked" id="profession-achievement">
                    <div class="achievement-icon">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <div class="achievement-title">Профессия</div>
                    <div class="achievement-desc">
                        Доступна на 75 уровне. Определите вашу специализацию.
                    </div>
                    <div class="locked-label">75 УР</div>
                </div>
                
                <!-- Master achievement -->
                <div class="achievement-card locked" id="master-achievement">
                    <div class="achievement-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="achievement-title">Мастер всех стихий</div>
                    <div class="achievement-desc">
                        Достигните 150 уровня. Максимальное мастерство!
                    </div>
                    <div class="locked-label">150 УР</div>
                </div>
            </div>
        </section>
        
        <!-- Daily Quests section -->
        <section id="quests-section" class="section quests-section">
            <div class="quests-header">
                <div class="quests-title-container">
                    <h2 class="section-title">Ежедневные квесты</h2>
                    <button id="replace-quest-btn" class="replace-quest-btn" title="Заменить квест">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <!-- NEW: Кнопка добавления своего квеста -->
                    <button id="add-custom-quest-btn" class="add-custom-quest-btn" title="Добавить свой квест">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="quests-grid" id="quests-container">
                <!-- Quests will be generated here -->
            </div>
            
            <div class="timer">
                Новые квесты через: <span id="timer">23:59:45</span>
            </div>
            
            <!-- Сообщение о выполнении всех квестов -->
            <div id="completed-all" class="completed-all" style="display: none;">
                <i class="fas fa-trophy"></i>
                <h3>Поздравляем с выполнением всех квестов за сегодня!</h3>
                <p>Вы стали на 1% лучше, чем вчера. Так держать!</p>
            </div>
        </section>
        
        <!-- Weekly Quest section -->
        <section id="weekly-quest-section" class="section weekly-quest-section">
            <h2 class="section-title">Еженедельный вызов</h2>
            
            <div class="weekly-quest-card" id="weekly-quest-card">
                <div class="weekly-quest-title">
                    <i class="fas fa-star"></i>
                    <span id="weekly-quest-title">Загрузка...</span>
                </div>
                <div class="weekly-quest-desc" id="weekly-quest-desc"></div>
                <div class="weekly-quest-reward">
                    <i class="fas fa-plus-circle"></i> Награда: +2 ко всем характеристикам
                    <span class="coin-icon">+3 L</span>
                </div>
                <button class="weekly-quest-btn" id="weekly-quest-btn">Выполнить</button>
            </div>
            
            <div class="weekly-timer">
                Новый вызов через: <span id="weekly-timer">6д 23:59:45</span>
            </div>
        </section>
        
        <!-- Shop section -->
        <section id="shop-section" class="section shop-section">
            <h2 class="section-title">Магазин</h2>
            <p class="text-center" style="margin-bottom: 20px;">Используй накопленные монеты для покупки сундуков</p>
            
            <div class="shop-grid" id="shop-grid">
                <div class="shop-item common" data-type="common">
                    <div class="chest-icon">
                        <i class="fas fa-box"></i>
                        <div class="chest-coins">
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                        </div>
                    </div>
                    <div class="shop-title">Обычный сундук</div>
                    <div class="shop-price">
                        <span>10</span>
                        <div class="coin"></div>
                    </div>
                    <button class="shop-btn" data-price="10">Купить</button>
                </div>
                
                <div class="shop-item rare" data-type="rare">
                    <div class="chest-icon">
                        <i class="fas fa-box-open"></i>
                        <div class="chest-coins">
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                        </div>
                    </div>
                    <div class="shop-title">Редкий сундук</div>
                    <div class="shop-price">
                        <span>25</span>
                        <div class="coin"></div>
                    </div>
                    <button class="shop-btn" data-price="25">Купить</button>
                </div>
                
                <div class="shop-item epic" data-type="epic">
                    <div class="chest-icon">
                        <i class="fas fa-archive"></i>
                        <div class="chest-coins">
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                        </div>
                    </div>
                    <div class="shop-title">Эпический сундук</div>
                    <div class="shop-price">
                        <span>50</span>
                        <div class="coin"></div>
                    </div>
                    <button class="shop-btn" data-price="50">Купить</button>
                </div>
                
                <div class="shop-item legendary" data-type="legendary">
                    <div class="chest-icon">
                        <i class="fas fa-gem"></i>
                        <div class="chest-coins">
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                            <span class="coin-float">🪙</span>
                        </div>
                    </div>
                    <div class="shop-title">Легендарный сундук</div>
                    <div class="shop-price">
                        <span>100</span>
                        <div class="coin"></div>
                    </div>
                    <button class="shop-btn" data-price="100">Купить</button>
                </div>
            </div>
        </section>
        
        <!-- NEW: Events feed section -->
        <section id="events-section" class="section">
            <h2 class="section-title">Лента событий</h2>
            <div id="events-list" class="events-list">
                <!-- Events will be added here -->
            </div>
        </section>
        
        <footer class="footer">
            <p>Прокачка персонажа в реальной жизни - система личностного роста</p>
            <div class="copyright">Разработано <a href="https://www.instagram.com/_lap_tev_?igsh=azZhN3I0Yzd4MmZt&utm_source=qr" target="_blank">LAPTEV</a> © 2023</div>
        </footer>
    </div>
    
    <!-- NEW: Модальное окно входа/регистрации -->
    <div class="modal login-modal" id="login-modal">
        <div class="modal-content">
            <h3 class="modal-title">Добро пожаловать!</h3>
            <p class="modal-text">Введите кодовое слово для доступа к вашему прогрессу:</p>
            
            <div class="login-form">
                <input type="text" id="user-code" class="login-input" placeholder="Введите кодовое слово (минимум 4 символа)" maxlength="20">
                <button class="btn" id="login-btn">Продолжить</button>
                <button class="btn" id="generate-code-btn">Создать новое слово</button>
            </div>
            
            <p class="login-help">
                Запомните это слово! Оно будет вашим ключом для доступа к прогрессу на любом устройстве.
                <br><br>
                <strong>Совет:</strong> Используйте комбинацию из слов и цифр, которую легко запомнить.
            </p>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="replace-confirm-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="modal-title">Подтверждение замены</h3>
            <p class="modal-text" id="replace-modal-text">Изменить квест можно только один раз в сутки. Вы уверены, что хотите заменить квест?</p>
            <div class="modal-options">
                <button class="btn" id="confirm-replace-btn">Да, заменить</button>
                <button class="btn" id="cancel-replace-btn">Отмена</button>
            </div>
        </div>
    </div>

    <!-- NEW: Модальное окно для создания своего квеста -->
    <div class="modal" id="custom-quest-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="modal-title">Создание своего квеста</h3>
            <div class="modal-form">
                <div class="form-group">
                    <label class="form-label" for="custom-quest-title">Название квеста:</label>
                    <input type="text" id="custom-quest-title" class="form-input" placeholder="Введите название квеста" maxlength="50">
                </div>
                <div class="form-group">
                    <label class="form-label" for="custom-quest-desc">Описание квеста:</label>
                    <textarea id="custom-quest-desc" class="form-textarea" placeholder="Опишите детали квеста" maxlength="200"></textarea>
                </div>
                <div class="modal-text">
                    <p>Награда за выполнение: +1 ко всем характеристикам и +1 монета</p>
                </div>
            </div>
            <div class="modal-options">
                <button class="btn" id="save-custom-quest-btn">Создать квест</button>
                <button class="btn" id="cancel-custom-quest-btn">Отмена</button>
            </div>
        </div>
    </div>

    <!-- NEW: Модальное окно подтверждения еженедельного квеста -->
    <div class="modal" id="weekly-confirm-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="modal-title">Подтверждение выполнения</h3>
            <p id="weekly-confirm-message" class="modal-text">Вы подтверждаете, что завершили еженедельный квест?</p>
            <div class="modal-options">
                <button class="btn" id="confirm-weekly-btn">Да, подтверждаю</button>
                <button class="btn" id="cancel-weekly-btn">Отмена</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="status-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="modal-title">Выберите ваш статус</h3>
            <p class="modal-text">Поздравляем! Вы достигли 50 уровня и можете выбрать свой статус.</p>
            <div class="modal-options">
                <button class="modal-option" data-status="prime">В прайме</button>
                <button class="modal-option" data-status="relaxed">На расслабоне</button>
                <button class="modal-option" data-status="in-the-zone">Вошел во вкус</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="profession-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="modal-title">Поздравляем с профессией!</h3>
            <p id="profession-message" class="modal-text"></p>
            <button class="btn" id="close-profession-modal">Понятно</button>
        </div>
    </div>
    
    <div class="modal" id="punishment-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="modal-title">Наказание за невыполнение</h3>
            <p id="punishment-message" class="modal-text"></p>
            <button class="btn" id="close-punishment-modal">Понятно</button>
        </div>
    </div>
    
    <div class="modal" id="confirm-quest-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="modal-title">Подтверждение выполнения</h3>
            <p id="confirm-quest-message" class="modal-text">Вы подтверждаете, что завершили этот квест?</p>
            <div class="modal-options">
                <button class="btn" id="confirm-quest-btn">Да, подтверждаю</button>
                <button class="btn" id="cancel-quest-btn">Отмена</button>
            </div>
        </div>
    </div>
    
    <!-- Attribute Description Modal -->
    <div class="modal" id="attribute-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="modal-title" id="attribute-modal-title">Описание характеристики</h3>
            <p id="attribute-modal-desc" class="modal-text"></p>
            <button class="btn" id="close-attribute-modal">Понятно</button>
        </div>
    </div>
    
    <!-- NEW: Rules Modal (заменяет Achievement Info Modal для правил) -->
    <div class="modal" id="rules-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="modal-title">Правила платформы</h3>
            <div class="modal-text" style="text-align: left; line-height: 1.6;">
                <p><strong>Правила платформы:</strong></p>
                <p>- Выполняйте ежедневные и еженедельные квесты, чтобы повышать характеристики и избегать наказания.</p>
                <p>- Копите монеты и получайте за них секретные бонусы внутри сундуков.</p>
                <p>- Поднимайте уровень и становитесь лучшей версией себя.</p>
                <p><br></p>
                <p><em>Желаю удачи. ©LAPTEV</em></p>
            </div>
            <button class="btn" id="close-rules-modal">Понятно</button>
        </div>
    </div>

    <!-- Achievement Info Modal -->
    <div class="modal" id="achievement-info-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="modal-title" id="achievement-modal-title">Информация о достижении</h3>
            <p id="achievement-modal-desc" class="modal-text"></p>
            <button class="btn" id="close-achievement-modal">Понятно</button>
        </div>
    </div>

    <!-- Shop Item Modal -->
    <div class="modal" id="shop-item-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="modal-title" id="shop-item-title"></h3>
            <p class="modal-text" id="shop-item-content"></p>
            <div class="modal-text">Цена: <span id="shop-item-price" class="coin-icon"></span></div>
            <div class="modal-options">
                <button class="btn" id="confirm-buy-btn">Купить</button>
                <button class="btn" id="cancel-buy-btn">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Level Info Modal -->
    <div class="modal" id="level-info-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 class="modal-title">Прогресс уровня</h3>
            <p id="level-info-content" class="modal-text"></p>
            <button class="btn" id="close-level-modal">Понятно</button>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            level: 1,
            attributes: {
                strength: 1,
                agility: 1,
                perception: 1,
                stamina: 1,
                intelligence: 1
            },
            totalPoints: 5,
            pointsToNextLevel: 10,
            currentPoints: 0,
            dailyQuests: [],
            weeklyQuest: null,
            questResetTime: null,
            weeklyResetTime: null,
            status: null,
            profession: null,
            replaceCount: 3,
            maxAttributeValue: 500,
            mandatoryQuestIndex: -1,
            consecutiveDays: 0,
            disciplineLevel: 0,
            weeklyStats: {
                strength: { points: 0, actions: [] },
                agility: { points: 0, actions: [] },
                perception: { points: 0, actions: [] },
                stamina: { points: 0, actions: [] },
                intelligence: { points: 0, actions: [] }
            },
            currentQuestIndex: -1,
            level150Achieved: false,
            coins: 0,
            chestsBought: [],
            maxReplaceCount: 3,
            maxDailyQuests: 6,
            noMandatoryPenalty: false,
            expMultiplier: 1,
            tempBonuses: [],
            events: [],
            theme: 'dark',
            customQuests: [],
            userId: null, // NEW: ID пользователя
            userCode: null // NEW: Кодовое слово пользователя
        };
        
        // Weekly quests database
        const weeklyQuests = [
            { title: "Проведи целый день без телефона и интернета", desc: "Отключи все цифровые устройства на 24 часа" },
            { title: "Откажись от сахара на 3 дня", desc: "Не употребляй сахар в любом виде в течение 3 дней" },
            { title: "Прочитай книгу", desc: "Прочитай книгу объемом не менее 200 страниц" },
            { title: "Принимай холодный душ каждое утро 5 дней подряд", desc: "Начинай каждое утро с холодного душа" },
            { title: "5 дней подряд просыпайся в 6 утра", desc: "Вставай в 6 утра независимо от дня недели" },
            { title: "Выполни утреннюю пробежку на 7 км", desc: "Пробеги 7 км за одну тренировку" },
            { title: "Выучи новый навык за 7 дней", desc: "Освой базовый уровень нового навыка за неделю" }
        ];
        
        // Database of quests (20 per attribute)
        const questsDatabase = {
            strength: [
                { title: "100 отжиманий", desc: "Выполните {count} отжиманий за один подход", points: 3, base: 100 },
                { title: "50 приседаний", desc: "Выполните {count} приседаний без перерыва", points: 2, base: 50 },
                { title: "20 подтягиваний", desc: "Выполните {count} подтягиваний (можно с перерывами)", points: 3, base: 20 },
                { title: "3 минуты планки", desc: "Удерживайте положение планки {count} минут", points: 2, base: 3 },
                { title: "50 выпадов", desc: "Выполните {count} выпадов (по {half} на каждую ногу)", points: 2, base: 50 },
                { title: "30 отжиманий на стуле", desc: "Выполните {count} отжиманий с использованием стула", points: 2, base: 30 },
                { title: "100 скручиваний", desc: "Выполните {count} скручиваний на пресс", points: 3, base: 100 },
                { title: "40 приседаний с прыжком", desc: "Выполните {count} приседаний с выпрыгиванием", points: 3, base: 40 },
                { title: "5 минут упражнений с эспандером", desc: "Тренируйте руки с эспандером {count} минут", points: 2, base: 5 },
                { title: "30 подъемов ног", desc: "Выполните {count} подъемов ног лежа на спине", points: 2, base: 30 },
                { title: "20 отжиманий с хлопком", desc: "Выполните {count} взрывных отжиманий с хлопком", points: 3, base: 20 },
                { title: "40 подъемов на носки", desc: "Выполните {count} подъемов на носки для икр", points: 1, base: 40 },
                { title: "25 бёрпи", desc: "Выполните {count} бёрпи (можно с перерывами)", points: 3, base: 25 },
                { title: "15 подтягиваний широким хватом", desc: "Выполните {count} подтягиваний широким хватом", points: 3, base: 15 },
                { title: "60 секунд стульчик у стены", desc: "Удерживайте позицию 'стульчик' у стены {count} секунд", points: 2, base: 60 },
                { title: "40 скручиваний с поворотом", desc: "Выполните {count} скручиваний с поворотом корпуса", points: 2, base: 40 },
                { title: "30 отжиманий узким хватом", desc: "Выполните {count} отжиманий с узкой постановкой рук", points: 2, base: 30 },
                { title: "50 подъемов корпуса", desc: "Выполните {count} подъемов корпуса для пресса", points: 2, base: 50 },
                { title: "20 отжиманий с ногами на возвышении", desc: "Выполните {count} отжиманий с ногами на стуле", points: 3, base: 20 },
                { title: "100 подъемов гантелей", desc: "Выполните {count} подъемов гантелей (любое упражнение)", points: 3, base: 100 }
            ],
            agility: [
                { title: "1000 прыжков на скакалке", desc: "Выполните {count} прыжков на скакалке", points: 3, base: 1000 },
                { title: "15 минут танцев", desc: "Танцуйте под любимую музыку {count} минут", points: 2, base: 15 },
                { title: "20 минут йоги", desc: "Практикуйте йогу {count} минут", points: 2, base: 20 },
                { title: "30 боксерских ударов", desc: "Выполните {count} боксерских комбинаций в воздухе", points: 2, base: 30 },
                { title: "10 минут прыжков джек", desc: "Выполняйте прыжки джек {count} минут", points: 3, base: 10 },
                { title: "5 минут прыжков на одной ноге", desc: "Прыгайте на одной ноге {count} минут (по {half} на каждую)", points: 2, base: 5 },
                { title: "15 минут зумбы", desc: "Занимайтесь зумбой или активными танцами {count} минут", points: 2, base: 15 },
                { title: "30 выпадов с прыжком", desc: "Выполните {count} выпадов с прыжком и сменой ног", points: 3, base: 30 },
                { title: "40 боковых прыжков", desc: "Выполните {count} прыжков в стороны через линию", points: 2, base: 40 },
                { title: "20 минут упражнений на растяжку", desc: "Выполняйте упражнения на растяжку {count} минут", points: 2, base: 20 },
                { title: "50 прыжков через скамью", desc: "Прыгайте через небольшую преграду {count} раз", points: 3, base: 50 },
                { title: "10 минут бега на месте", desc: "Бегайте на месте в высоком темпе {count} минут", points: 2, base: 10 },
                { title: "30 скручиваний корпуса", desc: "Выполните {count} быстрых скручиваний корпуса стоя", points: 2, base: 30 },
                { title: "15 минут упражнений с резиновой лентой", desc: "Тренируйтесь с резиновой лентой {count} минут", points: 2, base: 15 },
                { title: "40 приставных шагов", desc: "Выполните {count} приставных шагов в каждую сторону", points: 2, base: 40 },
                { title: "20 прыжков в длину", desc: "Выполните {count} прыжков в длину с места", points: 2, base: 20 },
                { title: "10 минут упражнений на координацию", desc: "Выполняйте упражнения на координацию {count} минут", points: 2, base: 10 },
                { title: "30 махов ногами", desc: "Выполните {count} махов ногами вперед-назад и в стороны", points: 2, base: 30 },
                { title: "15 минут тенниса с стеной", desc: "Играйте в теннис со стеной {count} минут", points: 3, base: 15 },
                { title: "50 прыжков с поворотом", desc: "Выполните {count} прыжков с поворотом на 180 градусов", points: 3, base: 50 }
            ],
            perception: [
                { title: "15 минут медитации", desc: "Медитируйте {count} минут, концентрируясь на дыхании", points: 2, base: 15 },
                { title: "10 минут осознанного наблюдения", desc: "Наблюдайте за природой или окружением {count} минут", points: 2, base: 10 },
                { title: "20 минут без гаджетов", desc: "Проведите {count} минут без телефона и компьютера", points: 2, base: 20 },
                { title: "30 минут прослушивания классики", desc: "Внимательно слушайте классическую музыку {count} минут", points: 3, base: 30 },
                { title: "Описать 10 предметов", desc: "Выберите {count} предметов и подробно опишите каждый", points: 3, base: 10 },
                { title: "10 минут слепой ходьбы", desc: "Пройдитесь по дому с закрытыми глазами {count} минут", points: 3, base: 10 },
                { title: "20 минут рисования", desc: "Рисуйте что-либо, обращая внимание на детали, {count} минут", points: 2, base: 20 },
                { title: "15 минут ароматерапии", desc: "Исследуйте разные ароматы с закрытыми глазами {count} минут", points: 2, base: 15 },
                { title: "30 минут чтения вслух", desc: "Читайте книку вслух, обращая внимание на интонацию, {count} минут", points: 2, base: 30 },
                { title: "Просмотр фильма без звука", desc: "Посмотрите {count} минут фильма без звука, следите за визуалом", points: 2, base: 20 },
                { title: "10 минут дыхательных упражнений", desc: "Практикуйте глубокое дыхание {count} минут", points: 2, base: 10 },
                { title: "20 минут пазлов", desc: "Соберите пазл или решите головоломку {count} минут", points: 2, base: 20 },
                { title: "15 минут наблюдения за животными", desc: "Наблюдайте за домашними животными или птицами {count} минут", points: 2, base: 15 },
                { title: "30 минут без фонового шума", desc: "Проведите {count} минут в полной тишине", points: 3, base: 30 },
                { title: "10 минут тактильных ощущений", desc: "Исследуйте разные текстуры с закрытыми глазами {count} минут", points: 2, base: 10 },
                { title: "20 минут созерцания искусства", desc: "Рассматривайте произведения искусства онлайн {count} минут", points: 2, base: 20 },
                { title: "15 минут ведения дневника", desc: "Опишите свои ощущения и мысли за день {count} минут", points: 2, base: 15 },
                { title: "10 минут концентрации на пламени", desc: "Смотрите на пламя свечи {count} минут", points: 2, base: 10 },
                { title: "20 минут без многозадачности", desc: "Выполняйте только одно дело {count} минут", points: 2, base: 20 },
                { title: "30 минут на природе", desc: "Проведите {count} минут на природе, обращая внимание на детали", points: 3, base: 30 }
            ],
            stamina: [
                { title: "20-минутная пробежка", desc: "Пробегите в легком темпе {count} минут без остановки", points: 3, base: 20 },
                { title: "30 минут велосипеда", desc: "Прокатитесь на велосипеде {count} минут", points: 3, base: 30 },
                { title: "40 минут быстрой ходьбы", desc: "Идите быстрым шагом {count} минут", points: 3, base: 40 },
                { title: "15 минут плавания", desc: "Плавайте в бассейне или открытой воде {count} минут", points: 3, base: 15 },
                { title: "60 минут работы в саду", desc: "Поработайте в саду или на даче {count} минут", points: 3, base: 60 },
                { title: "30 минут активной уборки", desc: "Выполняйте активную уборку дома {count} минут", points: 2, base: 30 },
                { title: "20 минут степ-аэробики", desc: "Занимайтесь степ-аэробикой {count} минут", points: 3, base: 20 },
                { title: "45 минут пешей прогулки", desc: "Гуляйте в среднем темпе {count} минут", points: 2, base: 45 },
                { title: "30 минут игры с детьми", desc: "Активно играйте с детьми {count} минут", points: 2, base: 30 },
                { title: "20 минут ходьбы по лестнице", desc: "Ходите вверх-вниз по лестнице {count} минут", points: 3, base: 20 },
                { title: "60 минут генеральной уборки", desc: "Проведите генеральную уборку {count} минут", points: 3, base: 60 },
                { title: "30 минут танцевального фитнеса", desc: "Занимайтесь танцевальным фитнесом {count} минут", points: 3, base: 30 },
                { title: "45 минут работы стоя", desc: "Работайте стоя {count} минут (за столом, кухней и т.д.)", points: 2, base: 45 },
                { title: "20 минут круговой тренировки", desc: "Выполните круговую тренировку {count} минут", points: 3, base: 20 },
                { title: "30 минут катания на роликах", desc: "Катайтесь на роликах или коньках {count} минут", points: 3, base: 30 },
                { title: "60 минут работы на даче", desc: "Поработайте на дачном участке {count} минут", points: 3, base: 60 },
                { title: "40 минут прогулки с собакой", desc: "Гуляйте с собакой в активном темпе {count} минут", points: 2, base: 40 },
                { title: "25 минут аквааэробики", desc: "Занимайтесь аквааэробикой в бассейне или ванне {count} минут", points: 3, base: 25 },
                { title: "35 минут скандинавской ходьбы", desc: "Практикуйте скандинавскую ходьбу {count} минут", points: 3, base: 35 },
                { title: "50 минут работы по дому", desc: "Выполняйте различные работы по дому {count} минут", points: 3, base: 50 }
            ],
            intelligence: [
                { title: "30 минут чтения", desc: "Читайте книгу или научную статью {count} минут", points: 3, base: 30 },
                { title: "20 минут изучения языка", desc: "Занимайтесь изучением нового языка {count} минут", points: 2, base: 20 },
                { title: "15 решения головоломок", desc: "Решите несколько сложных головоломок за {count} минут", points: 2, base: 15 },
                { title: "30 минут документального фильма", desc: "Посмотрите научно-популярный фильм {count} минут", points: 2, base: 30 },
                { title: "20 минут обучения новому навыку", desc: "Потратьте {count} минут на изучение нового навыка", points: 2, base: 20 },
                { title: "40 минут написания текста", desc: "Напишите статью, эссе или рассказ за {count} минут", points: 3, base: 40 },
                { title: "30 минут шахмат", desc: "Сыграйте в шахматы (можно онлайн) {count} минут", points: 3, base: 30 },
                { title: "20 минут изучения истории", desc: "Изучите исторический период или событие {count} минут", points: 2, base: 20 },
                { title: "25 минут программирования", desc: "Поработайте над программистским проектом {count} минут", points: 3, base: 25 },
                { title: "30 минут анализа проблемы", desc: "Проанализируйте сложную проблему и предложите решения за {count} минут", points: 3, base: 30 },
                { title: "20 минут ментальной арифметики", desc: "Практикуйте устный счет и вычисления {count} минут", points: 2, base: 20 },
                { title: "40 минут онлайн-курса", desc: "Пройдите часть онлайн-курса по новой теме за {count} минут", points: 3, base: 40 },
                { title: "30 минут стратегической игры", desc: "Сыграйте в стратегическую игру (шахматы, го и т.д.) {count} минут", points: 2, base: 30 },
                { title: "20 минут запоминания", desc: "Попрактикуйте техники запоминания {count} минут", points: 2, base: 20 },
                { title: "30 минут изучения карты", desc: "Изучите географическую карту нового региона {count} минут", points: 2, base: 30 },
                { title: "25 минут научного подкаста", desc: "Прослушайте научно-популярный подкаст {count} минут", points: 2, base: 25 },
                { title: "20 минут кроссвордов", desc: "Решите кроссворд или сканворд за {count} минут", points: 2, base: 20 },
                { title: "40 минут изучения искусства", desc: "Изучите творчество какого-либо художника {count} минут", points: 2, base: 40 },
                { title: "30 минут финансового планирования", desc: "Займитесь финансовым планированием и анализом {count} минут", points: 3, base: 30 },
                { title: "25 минут философских размышлений", desc: "Размышляйте на философскую тему {count} минут", points: 2, base: 25 }
            ]
        };
        
        // Обязательные квесты
        const mandatoryQuests = [
            { title: "Проведи 30 минут на свежем воздухе", desc: "Выйди на улицу и проведи время на природе", points: 0 },
            { title: "Выпей 2 литра воды", desc: "Соблюди водный баланс в течение дня", points: 0 },
            { title: "Сделай 5 добрых дел", desc: "Помоги другим людям или животным", points: 0 },
            { title: "Спи не менее 7 часов", desc: "Обеспечь себе полноценный ночной сон", points: 0 },
            { title: "Запиши 3 благодарности", desc: "Запиши три вещи, за которые ты благодарен сегодня", points: 0 }
        ];
        
        // Достижения дисциплины
        const disciplineLevels = [
            { name: "Новичок", days: 7, title: "Знаток дисциплины" },
            { name: "Знаток", days: 14, title: "Эксперт дисциплины" },
            { name: "Эксперт", days: 21, title: "Мастер дисциплины" },
            { name: "Мастер", days: 28, title: "Бог дисциплины", max: true }
        ];
        
        // Описания характеристик
        const attributeDescriptions = {
            strength: "Физическая мощь и мышечная развитость. Влияет на выполнение силовых упражнений и физической работы.",
            agility: "Координация, скорость реакции и гибкость. Важна для спортивных и подвижных задач, требующих ловкости.",
            perception: "Осознанность, внимание к деталям и способность замечать изменения. Развивает наблюдательность и чувствительность к окружению.",
            stamina: "Способность выдерживать длительные нагрузки без усталости. Увеличивает работоспособность и выносливость в повседневных задачах.",
            intelligence: "Умственные способности, логика и обучаемость. Помогает в решении сложных задач, обучении новым навыкам и анализе информации."
        };
        
        // Описания сундуков
        const chestDescriptions = {
            common: "Сюрприз от системы",
            rare: "Подарок от системы",
            epic: "Благославение системы",
            legendary: "Любимчик системы"
        };
        
        // DOM elements
        const levelElement = document.getElementById('level');
        const levelProgressBar = document.getElementById('level-progress-bar');
        const levelProgressContainer = document.getElementById('level-progress-container');
        const attributeCards = {
            strength: document.getElementById('strength-card'),
            agility: document.getElementById('agility-card'),
            perception: document.getElementById('perception-card'),
            stamina: document.getElementById('stamina-card'),
            intelligence: document.getElementById('intelligence-card')
        };
        const attributeValues = document.querySelectorAll('.attribute-value');
        const progressBars = document.querySelectorAll('.progress-bar');
        const questsContainer = document.getElementById('quests-container');
        const achievementCards = {
            status: document.getElementById('status-achievement'),
            profession: document.getElementById('profession-achievement'),
            rules: document.getElementById('rules-achievement'),
            master: document.getElementById('master-achievement')
        };
        const startButton = document.getElementById('start-btn');
        const questsSection = document.getElementById('quests-section');
        const timerElement = document.getElementById('timer');
        const statusIndicator = document.getElementById('status-indicator');
        const professionIndicator = document.getElementById('profession-indicator');
        const replaceQuestBtn = document.getElementById('replace-quest-btn');
        const addCustomQuestBtn = document.getElementById('add-custom-quest-btn');
        const replaceConfirmModal = document.getElementById('replace-confirm-modal');
        const replaceModalText = document.getElementById('replace-modal-text');
        const confirmReplaceBtn = document.getElementById('confirm-replace-btn');
        const cancelReplaceBtn = document.getElementById('cancel-replace-btn');
        const customQuestModal = document.getElementById('custom-quest-modal');
        const customQuestTitle = document.getElementById('custom-quest-title');
        const customQuestDesc = document.getElementById('custom-quest-desc');
        const saveCustomQuestBtn = document.getElementById('save-custom-quest-btn');
        const cancelCustomQuestBtn = document.getElementById('cancel-custom-quest-btn');
        const statusModal = document.getElementById('status-modal');
        const professionModal = document.getElementById('profession-modal');
        const professionMessage = document.getElementById('profession-message');
        const punishmentModal = document.getElementById('punishment-modal');
        const punishmentMessage = document.getElementById('punishment-message');
        const weeklyQuestTitle = document.getElementById('weekly-quest-title');
        const weeklyQuestDesc = document.getElementById('weekly-quest-desc');
        const weeklyQuestBtn = document.getElementById('weekly-quest-btn');
        const weeklyTimerElement = document.getElementById('weekly-timer');
        const weeklyQuestCard = document.getElementById('weekly-quest-card');
        const sundayNotice = document.getElementById('sunday-notice');
        const weekReport = document.getElementById('week-report');
        const weekReportContent = document.getElementById('week-report-content');
        const completedAll = document.getElementById('completed-all');
        const confirmQuestModal = document.getElementById('confirm-quest-modal');
        const confirmQuestMessage = document.getElementById('confirm-quest-message');
        const confirmQuestBtn = document.getElementById('confirm-quest-btn');
        const cancelQuestBtn = document.getElementById('cancel-quest-btn');
        const attributeModal = document.getElementById('attribute-modal');
        const attributeModalTitle = document.getElementById('attribute-modal-title');
        const attributeModalDesc = document.getElementById('attribute-modal-desc');
        const achievementModal = document.getElementById('achievement-info-modal');
        const achievementModalTitle = document.getElementById('achievement-modal-title');
        const achievementModalDesc = document.getElementById('achievement-modal-desc');
        const coinsElement = document.getElementById('coins');
        const walletElement = document.getElementById('wallet');
        const levelContainer = document.getElementById('level-container');
        const shopItemModal = document.getElementById('shop-item-modal');
        const shopItemTitle = document.getElementById('shop-item-title');
        const shopItemContent = document.getElementById('shop-item-content');
        const shopItemPrice = document.getElementById('shop-item-price');
        const confirmBuyBtn = document.getElementById('confirm-buy-btn');
        const cancelBuyBtn = document.getElementById('cancel-buy-btn');
        const levelInfoModal = document.getElementById('level-info-modal');
        const levelInfoContent = document.getElementById('level-info-content');
        const shopGrid = document.getElementById('shop-grid');
        const eventsList = document.getElementById('events-list');
        const notificationsContainer = document.getElementById('notifications-container');
        const themeToggle = document.getElementById('theme-toggle');
        const loginModal = document.getElementById('login-modal');
        const userCodeInput = document.getElementById('user-code');
        const loginBtn = document.getElementById('login-btn');
        const generateCodeBtn = document.getElementById('generate-code-btn');
        const userInfo = document.getElementById('user-info');
        const userIdDisplay = document.getElementById('user-id-display');
        const logoutBtn = document.getElementById('logout-btn');
        const weeklyConfirmModal = document.getElementById('weekly-confirm-modal');
        const weeklyConfirmMessage = document.getElementById('weekly-confirm-message');
        const confirmWeeklyBtn = document.getElementById('confirm-weekly-btn');
        const cancelWeeklyBtn = document.getElementById('cancel-weekly-btn');
        const rulesModal = document.getElementById('rules-modal');
        const closeRulesBtn = document.getElementById('close-rules-modal');
        
        // NEW: Система пользователей
        let currentUser = null;
        
        // Generate random user ID
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Generate easy-to-remember code
        function generateEasyCode() {
            const adjectives = ['быстрый', 'умный', 'сильный', 'ловкий', 'стойкий', 'смелый', 'яркий', 'тихий', 'горячий', 'холодный'];
            const nouns = ['тигр', 'орел', 'волк', 'дракон', 'феникс', 'леопард', 'ястреб', 'медведь', 'лев', 'единорог'];
            const numbers = Math.floor(100 + Math.random() * 900);
            
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            
            return `${adj}_${noun}_${numbers}`;
        }
        
        // Save user data
        function saveUserData(userId, userCode, data) {
            const userKey = `user_${userId}`;
            const userData = {
                userId: userId,
                userCode: userCode,
                data: data,
                lastLogin: Date.now()
            };
            
            localStorage.setItem(userKey, JSON.stringify(userData));
            
            // Также сохраняем mapping code->userId для быстрого поиска
            const codeMap = JSON.parse(localStorage.getItem('userCodeMap') || '{}');
            codeMap[userCode] = userId;
            localStorage.setItem('userCodeMap', JSON.stringify(codeMap));
        }
        
        // Load user data
        function loadUserData(userId) {
            const userKey = `user_${userId}`;
            const userData = localStorage.getItem(userKey);
            
            if (userData) {
                return JSON.parse(userData);
            }
            
            return null;
        }
        
        // Find user by code
        function findUserByCode(code) {
            const codeMap = JSON.parse(localStorage.getItem('userCodeMap') || '{}');
            const userId = codeMap[code];
            
            if (userId) {
                return loadUserData(userId);
            }
            
            return null;
        }
        
        // Login user
        function loginUser(userCode) {
            let userData = findUserByCode(userCode);
            
            if (!userData) {
                // Create new user
                const userId = generateUserId();
                userData = {
                    userId: userId,
                    userCode: userCode,
                    data: { ...gameState },
                    lastLogin: Date.now()
                };
                
                saveUserData(userId, userCode, gameState);
                showNotification('👋 Добро пожаловать!', 'Создан новый аккаунт', 'success');
            } else {
                // Load existing user data
                Object.assign(gameState, userData.data);
                showNotification('👋 С возвращением!', 'Ваш прогресс загружен', 'success');
            }
            
            currentUser = userData.userId;
            gameState.userId = userData.userId;
            gameState.userCode = userData.userCode;
            
            // Update UI
            userIdDisplay.textContent = userData.userCode;
            userInfo.style.display = 'flex';
            loginModal.style.display = 'none';
            
            // Save to session for quick access
            sessionStorage.setItem('currentUserId', userData.userId);
            
            // Initialize game with loaded data
            initGameWithData();
        }
        
        // Logout user
        function logoutUser() {
            // Save current progress before logout
            if (currentUser) {
                saveUserData(currentUser, gameState.userCode, gameState);
            }
            
            currentUser = null;
            gameState.userId = null;
            gameState.userCode = null;
            
            // Clear session
            sessionStorage.removeItem('currentUserId');
            
            // Reset UI
            userInfo.style.display = 'none';
            loginModal.style.display = 'flex';
            
            // Reset game state to defaults (but keep in memory for new login)
            Object.assign(gameState, {
                level: 1,
                attributes: {
                    strength: 1,
                    agility: 1,
                    perception: 1,
                    stamina: 1,
                    intelligence: 1
                },
                totalPoints: 5,
                pointsToNextLevel: 10,
                currentPoints: 0,
                dailyQuests: [],
                weeklyQuest: null,
                questResetTime: null,
                weeklyResetTime: null,
                status: null,
                profession: null,
                replaceCount: 3,
                maxAttributeValue: 500,
                mandatoryQuestIndex: -1,
                consecutiveDays: 0,
                disciplineLevel: 0,
                weeklyStats: {
                    strength: { points: 0, actions: [] },
                    agility: { points: 0, actions: [] },
                    perception: { points: 0, actions: [] },
                    stamina: { points: 0, actions: [] },
                    intelligence: { points: 0, actions: [] }
                },
                currentQuestIndex: -1,
                level150Achieved: false,
                coins: 0,
                chestsBought: [],
                maxReplaceCount: 3,
                maxDailyQuests: 6,
                noMandatoryPenalty: false,
                expMultiplier: 1,
                tempBonuses: [],
                events: [],
                theme: 'dark',
                customQuests: [],
                userId: null,
                userCode: null
            });
            
            showNotification('👋 До свидания!', 'Вы вышли из системы', 'info');
        }
        
        // Check auto-login
        function checkAutoLogin() {
            const savedUserId = sessionStorage.getItem('currentUserId');
            
            if (savedUserId) {
                const userData = loadUserData(savedUserId);
                if (userData) {
                    currentUser = userData.userId;
                    Object.assign(gameState, userData.data);
                    
                    // Update UI
                    userIdDisplay.textContent = userData.userCode;
                    userInfo.style.display = 'flex';
                    
                    initGameWithData();
                    return true;
                }
            }
            
            return false;
        }
        
        // Initialize game with loaded data
        function initGameWithData() {
            checkSundayBonus();
            setupEventListeners();
            startTimers();
            generateDailyQuests();
            generateWeeklyQuest();
            updateStats();
            updateReplaceCounter();
            updateCoinsDisplay();
            renderEvents();
            applyTheme();
            
            // Add login event
            addEvent(`🔑 Вход в систему: ${gameState.userCode}`, 'info');
        }
        
        // Initialize game
        function initGame() {
            // Check if user is already logged in
            if (!checkAutoLogin()) {
                // Show login modal
                loginModal.style.display = 'flex';
            }
            
            // Setup login event listeners
            setupLoginListeners();
        }
        
        // Setup login event listeners
        function setupLoginListeners() {
            loginBtn.addEventListener('click', function() {
                const code = userCodeInput.value.trim();
                
                if (code.length < 4) {
                    alert('Кодовое слово должно содержать минимум 4 символа');
                    return;
                }
                
                loginUser(code);
            });
            
            generateCodeBtn.addEventListener('click', function() {
                const easyCode = generateEasyCode();
                userCodeInput.value = easyCode;
                showNotification('✨ Сгенерирован код', `Ваш код: ${easyCode}`, 'info');
            });
            
            logoutBtn.addEventListener('click', logoutUser);
            
            // Allow Enter key to login
            userCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginBtn.click();
                }
            });
        }
        
        // Save game state
        function saveGame() {
            if (currentUser) {
                saveUserData(currentUser, gameState.userCode, gameState);
            }
        }
        
        // Load game state from localStorage
        function loadGame() {
            // Already loaded in loginUser or checkAutoLogin
            return;
        }
        
        // Apply theme
        function applyTheme() {
            if (gameState.theme === 'light') {
                document.body.classList.add('light-theme');
                themeToggle.querySelector('i').classList.remove('fa-moon');
                themeToggle.querySelector('i').classList.add('fa-sun');
            } else {
                document.body.classList.remove('light-theme');
                themeToggle.querySelector('i').classList.remove('fa-sun');
                themeToggle.querySelector('i').classList.add('fa-moon');
            }
        }
        
        // Toggle theme
        function toggleTheme() {
            if (gameState.theme === 'dark') {
                gameState.theme = 'light';
            } else {
                gameState.theme = 'dark';
            }
            applyTheme();
            saveGame();
        }
        
        // Check if it's Sunday for bonus
        function checkSundayBonus() {
            const today = new Date();
            if (today.getDay() === 0) { // 0 = Sunday
                sundayNotice.style.display = 'block';
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.add('sunday');
                });
            }
        }
        
        // Set quest reset time (next 24 hours)
        function setQuestResetTime() {
            const now = Date.now();
            gameState.questResetTime = now + 24 * 60 * 60 * 1000;
            saveGame();
        }
        
        // Set weekly quest reset time (next 7 days)
        function setWeeklyResetTime() {
            const now = Date.now();
            gameState.weeklyResetTime = now + 7 * 24 * 60 * 60 * 1000;
            saveGame();
        }
        
        // Update replace quest counter display
        function updateReplaceCounter() {
            replaceQuestBtn.disabled = gameState.replaceCount <= 0;
        }
        
        // Update coins display
        function updateCoinsDisplay() {
            coinsElement.textContent = gameState.coins;
        }
        
        // Generate daily quests
        function generateDailyQuests() {
            questsContainer.innerHTML = '';
            
            if (gameState.dailyQuests && gameState.dailyQuests.length > 0) {
                gameState.dailyQuests.forEach((quest, index) => {
                    const questCard = createQuestCard(quest, index);
                    questsContainer.appendChild(questCard);
                });
                return;
            }
            
            gameState.dailyQuests = [];
            
            // Обычные квесты (количество зависит от купленных сундуков)
            const regularQuestCount = gameState.maxDailyQuests - 1; // Один слот для обязательного квеста
            
            // Выбираем случайные атрибуты для квестов
            const attributes = Object.keys(questsDatabase);
            for (let i = 0; i < regularQuestCount; i++) {
                const attribute = attributes[i % attributes.length];
                const quests = questsDatabase[attribute];
                const randomIndex = Math.floor(Math.random() * quests.length);
                const baseQuest = quests[randomIndex];
                
                // Рассчитываем сложность на основе уровня
                const difficultyMultiplier = 1 + (Math.floor(gameState.level / 10) * 0.1);
                const adjustedCount = Math.round(baseQuest.base * difficultyMultiplier);
                
                // Форматируем описание
                let desc = baseQuest.desc.replace('{count}', adjustedCount);
                desc = desc.replace('{half}', Math.round(adjustedCount / 2));
                
                // ИСПРАВЛЕНО: Шанс 50% на получение монеты
                const coinReward = Math.random() < 0.5;
                
                const quest = {
                    title: baseQuest.title,
                    desc: desc,
                    points: baseQuest.points,
                    attribute: attribute,
                    completed: false,
                    mandatory: false,
                    base: baseQuest.base,
                    adjustedCount: adjustedCount,
                    coinReward: coinReward
                };
                
                gameState.dailyQuests.push(quest);
            }
            
            // Обязательный квест
            const mandatoryIndex = Math.floor(Math.random() * mandatoryQuests.length);
            const mandatoryQuest = mandatoryQuests[mandatoryIndex];
            gameState.dailyQuests.push({
                title: mandatoryQuest.title,
                desc: mandatoryQuest.desc,
                points: mandatoryQuest.points,
                attribute: 'all',
                completed: false,
                mandatory: true,
                coinReward: false
            });
            
            gameState.mandatoryQuestIndex = gameState.maxDailyQuests - 1;
            
            // NEW: Добавляем пользовательские квесты
            if (gameState.customQuests && gameState.customQuests.length > 0) {
                gameState.customQuests.forEach(quest => {
                    if (!quest.completed) {
                        gameState.dailyQuests.push({
                            ...quest,
                            custom: true
                        });
                    }
                });
            }
            
            gameState.dailyQuests.forEach((quest, index) => {
                const questCard = createQuestCard(quest, index);
                questsContainer.appendChild(questCard);
            });
            
            saveGame();
            updateReplaceCounter();
        }
        
        // Create quest card DOM element
        function createQuestCard(quest, index) {
            const questCard = document.createElement('div');
            questCard.className = 'quest-card';
            questCard.dataset.index = index;
            
            if (quest.mandatory) {
                questCard.classList.add('mandatory-quest');
            } else if (quest.custom) {
                questCard.classList.add('custom-quest');
            }
            
            let rewardText = quest.mandatory ? 
                'Избежит наказания' : 
                `+${quest.points} к ${getAttributeName(quest.attribute)}`;
            
            // NEW: Для пользовательских квестов специальная награда
            if (quest.custom) {
                rewardText = '+1 ко всем характеристикам';
            }
            
            if (quest.coinReward || quest.custom) {
                rewardText += ` <span class="coin-icon">+1 L</span>`;
            }
            
            questCard.innerHTML = `
                ${quest.mandatory ? '<div class="mandatory-label">⚠️ Обязательный</div>' : ''}
                ${quest.custom ? '<div class="custom-label">✨ Свой квест</div>' : ''}
                <div class="quest-title">${quest.title}</div>
                <div class="quest-desc">${quest.desc}</div>
                <div class="quest-reward">
                    <i class="fas fa-plus-circle"></i> ${rewardText}
                </div>
                <button class="quest-btn ${quest.completed ? 'completed' : ''}" 
                        data-attribute="${quest.attribute}" 
                        data-points="${quest.points}"
                        data-coin="${quest.coinReward || quest.custom}"
                        data-index="${index}">
                    ${quest.completed ? 'Выполнено!' : 'Выполнить'}
                </button>
            `;
            return questCard;
        }
        
        // Generate weekly quest
        function generateWeeklyQuest() {
            if (gameState.weeklyQuest) {
                weeklyQuestTitle.textContent = gameState.weeklyQuest.title;
                weeklyQuestDesc.textContent = gameState.weeklyQuest.desc;
                weeklyQuestBtn.textContent = gameState.weeklyQuest.completed ? 'Выполнено!' : 'Выполнить';
                weeklyQuestBtn.classList.toggle('completed', gameState.weeklyQuest.completed);
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * weeklyQuests.length);
            gameState.weeklyQuest = {
                ...weeklyQuests[randomIndex],
                completed: false
            };
            
            weeklyQuestTitle.textContent = gameState.weeklyQuest.title;
            weeklyQuestDesc.textContent = gameState.weeklyQuest.desc;
            weeklyQuestBtn.textContent = 'Выполнить';
            weeklyQuestBtn.classList.remove('completed');
            
            saveGame();
        }
        
        function getAttributeName(attr) {
            const names = {
                strength: "Силе",
                agility: "Ловкости",
                perception: "Восприятию",
                stamina: "Выносливости",
                intelligence: "Интеллекту",
                all: "всем характеристикам"
            };
            return names[attr] || attr;
        }
        
        // Show replace confirmation modal
        function showReplaceConfirmModal() {
            if (gameState.replaceCount <= 0) {
                alert('У вас больше нет доступных замен квестов, подождите завтрашний день');
                return;
            }
            
            replaceModalText.innerHTML = `У вас осталось <strong>${gameState.replaceCount}</strong> замен. Вы уверены, что хотите заменить квест?`;
            replaceConfirmModal.style.display = 'flex';
        }
        
        // Hide replace confirmation modal
        function hideReplaceConfirmModal() {
            replaceConfirmModal.style.display = 'none';
        }
        
        // NEW: Показать модальное окно создания квеста
        function showCustomQuestModal() {
            customQuestTitle.value = '';
            customQuestDesc.value = '';
            customQuestModal.style.display = 'flex';
        }
        
        // NEW: Скрыть модальное окно создания квеста
        function hideCustomQuestModal() {
            customQuestModal.style.display = 'none';
        }
        
        // NEW: Сохранить пользовательский квест
        function saveCustomQuest() {
            const title = customQuestTitle.value.trim();
            const desc = customQuestDesc.value.trim();
            
            if (!title) {
                alert('Пожалуйста, введите название квеста');
                return;
            }
            
            if (!desc) {
                alert('Пожалуйста, введите описание квеста');
                return;
            }
            
            const customQuest = {
                title: title,
                desc: desc,
                points: 1,
                attribute: 'all',
                completed: false,
                custom: true,
                coinReward: true
            };
            
            // Добавляем квест в массив пользовательских квестов
            if (!gameState.customQuests) {
                gameState.customQuests = [];
            }
            gameState.customQuests.push(customQuest);
            
            // Добавляем квест в список ежедневных квестов
            gameState.dailyQuests.push(customQuest);
            
            // Обновляем отображение квестов
            generateDailyQuests();
            saveGame();
            hideCustomQuestModal();
            
            // Добавляем событие в ленту
            addEvent(`✨ Создан новый квест: "${title}"`, 'info');
            showNotification('✨ Новый квест!', 'Вы создали свой собственный квест', 'success');
        }
        
        // NEW: Показать подтверждение выполнения еженедельного квеста
        function showWeeklyConfirmModal() {
            if (gameState.weeklyQuest.completed) {
                alert('Вы уже выполнили этот еженедельный квест!');
                return;
            }
            
            weeklyConfirmMessage.textContent = `Вы подтверждаете, что завершили еженедельный квест "${gameState.weeklyQuest.title}"?`;
            weeklyConfirmModal.style.display = 'flex';
        }
        
        // NEW: Скрыть подтверждение выполнения еженедельного квеста
        function hideWeeklyConfirmModal() {
            weeklyConfirmModal.style.display = 'none';
        }
        
        // Activate quest replace mode
        function activateReplaceMode() {
            questsContainer.classList.add('replace-mode');
            hideReplaceConfirmModal();
            
            // Добавляем обработчики для выбора квеста для замены
            const questCards = document.querySelectorAll('.quest-card');
            questCards.forEach(card => {
                card.addEventListener('click', handleQuestSelectionForReplacement);
            });
            
            showNotification('🔁 Режим замены', 'Выберите квест для замены', 'info');
        }
        
        // Handle quest selection for replacement
        function handleQuestSelectionForReplacement(event) {
            const questCard = event.currentTarget;
            const questIndex = parseInt(questCard.dataset.index);
            
            // Отменяем замену если кликнули на кнопку выполнения
            if (event.target.classList.contains('quest-btn')) {
                return;
            }
            
            // NEW: Нельзя заменить пользовательские квесты
            if (gameState.dailyQuests[questIndex].custom) {
                alert('Этот квест создан вами и не может быть заменен!');
                return;
            }
            
            replaceQuest(questCard, questIndex);
            
            // Удаляем обработчики после замена
            const questCards = document.querySelectorAll('.quest-card');
            questCards.forEach(card => {
                card.removeEventListener('click', handleQuestSelectionForReplacement);
            });
            
            questsContainer.classList.remove('replace-mode');
        }
        
        // Replace a quest
        function replaceQuest(questCard, questIndex) {
            if (questIndex === gameState.mandatoryQuestIndex && !gameState.noMandatoryPenalty) {
                alert('Этот квест обязательный! Его нельзя заменить.');
                return;
            }
            
            const attribute = gameState.dailyQuests[questIndex].attribute;
            const quests = questsDatabase[attribute];
            
            const randomIndex = Math.floor(Math.random() * quests.length);
            const baseQuest = quests[randomIndex];
            
            // Рассчитываем сложность на основе уровня
            const difficultyMultiplier = 1 + (Math.floor(gameState.level / 10) * 0.1);
            const adjustedCount = Math.round(baseQuest.base * difficultyMultiplier);
            
            // Форматируем описание
            let desc = baseQuest.desc.replace('{count}', adjustedCount);
            desc = desc.replace('{half}', Math.round(adjustedCount / 2));
            
            // ИСПРАВЛЕНО: Шанс 50% на получение монеты
            const coinReward = Math.random() < 0.5;
            
            const newQuest = {
                title: baseQuest.title,
                desc: desc,
                points: baseQuest.points,
                attribute: attribute,
                completed: false,
                mandatory: false,
                base: baseQuest.base,
                adjustedCount: adjustedCount,
                coinReward: coinReward
            };
            
            gameState.dailyQuests[questIndex] = newQuest;
            gameState.replaceCount--;
            
            generateDailyQuests();
            saveGame();
            
            replaceQuestBtn.classList.add('rotating');
            setTimeout(() => {
                replaceQuestBtn.classList.remove('rotating');
            }, 1000);
            
            // Добавляем событие в ленту
            addEvent(`🔁 Замена квеста: "${newQuest.title}"`, 'warning');
            showNotification('🔁 Квест заменен!', `Новый квест: "${newQuest.title}"`, 'info');
        }
        
        // Check if mandatory quest was completed
        function checkMandatoryQuest() {
            const mandatoryQuest = gameState.dailyQuests[gameState.mandatoryQuestIndex];
            
            if (mandatoryQuest && !mandatoryQuest.completed && !gameState.noMandatoryPenalty) {
                // Определяем множитель штрафа (2x в воскресенье)
                const penaltyMultiplier = new Date().getDay() === 0 ? 2 : 1;
                let actualPoints = penaltyMultiplier;
                
                // Применяем бонусы от сундуков
                actualPoints = Math.round(actualPoints * gameState.expMultiplier);
                
                punishmentMessage.textContent = `Вы не выполнили обязательный квест! Ваше наказание: -${penaltyMultiplier} ко всем характеристикам.`;
                punishmentModal.style.display = 'flex';
                
                // Применяем наказание
                Object.keys(gameState.attributes).forEach(attr => {
                    gameState.attributes[attr] = Math.max(1, gameState.attributes[attr] - actualPoints);
                });
                
                saveGame();
                updateStats();
                
                // Добавляем событие в ленту
                addEvent(`⚠️ Штраф: не выполнен обязательный квест`, 'danger');
                showNotification('⚠️ Штраф!', 'Вы не выполнили обязательный квест', 'danger');
            }
            
            // Проверяем выполнение всех квестов для достижения дисциплины
            checkAllQuestsCompleted();
        }
        
        // Reset weekly quest
        function resetWeeklyQuest() {
            gameState.weeklyQuest = null;
            generateWeeklyQuest();
            setWeeklyResetTime();
        }
        
        // Show weekly report
        function showWeeklyReport() {
            weekReport.style.display = 'block';
            
            let reportHTML = '<ul>';
            let totalPoints = 0;
            
            Object.keys(gameState.weeklyStats).forEach(attr => {
                if (gameState.weeklyStats[attr].points > 0) {
                    totalPoints += gameState.weeklyStats[attr].points;
                    reportHTML += `<li><b>${getAttributeName(attr)}</b>: +${gameState.weeklyStats[attr].points} очков`;
                    
                    if (gameState.weeklyStats[attr].actions.length > 0) {
                        reportHTML += `<ul>`;
                        gameState.weeklyStats[attr].actions.forEach(action => {
                            reportHTML += `<li>${action}</li>`;
                        });
                        reportHTML += `</ul>`;
                    }
                    
                    reportHTML += `</li>`;
                }
            });
            
            reportHTML += `</ul>`;
            reportHTML += `<p><b>Итого за неделю</b>: +${totalPoints} очков характеристик</p>`;
            reportHTML += `<p>Так держать! Продолжайте в том же духе!</p>`;
            
            weekReportContent.innerHTML = reportHTML;
            
            // Сбрасываем статистику за неделю
            Object.keys(gameState.weeklyStats).forEach(attr => {
                gameState.weeklyStats[attr] = { points: 0, actions: [] };
            });
            saveGame();
            
            // Добавляем событие в ленту
            addEvent(`📊 Недельный отчет: +${totalPoints} очков характеристик`, 'info');
            showNotification('📊 Недельный отчет готов!', `Вы получили +${totalPoints} очков характеристик`, 'info');
        }
        
        // Calculate points needed for next level
        function calculatePointsToNextLevel() {
            const levelGroup = Math.floor((gameState.level - 1) / 10);
            let requiredPoints = 10 + levelGroup;
            
            // После 100 уровня фиксируем на 20 очках
            if (requiredPoints > 20) {
                requiredPoints = 20;
            }
            
            return requiredPoints;
        }
        
        // Update stats display
        function updateStats() {
            levelElement.textContent = `Уровень ${gameState.level}`;
            
            // Обновляем требуемое количество очков для следующего уровня
            gameState.pointsToNextLevel = calculatePointsToNextLevel();
            
            const levelProgressPercentage = (gameState.currentPoints / gameState.pointsToNextLevel) * 100;
            levelProgressBar.style.width = `${levelProgressPercentage}%`;
            
            Object.keys(gameState.attributes).forEach((attr, index) => {
                const value = gameState.attributes[attr];
                attributeValues[index].textContent = `${value} / ${gameState.maxAttributeValue}`;
                
                const progressPercentage = (value / gameState.maxAttributeValue) * 100;
                progressBars[index].style.width = `${progressPercentage}%`;
            });
            
            // Обновление достижений
            if (gameState.level >= 50) {
                achievementCards.status.classList.remove('locked');
                if (!gameState.status) {
                    setTimeout(() => {
                        showStatusModal();
                    }, 500);
                }
            }
            
            if (gameState.level >= 75) {
                achievementCards.profession.classList.remove('locked');
                if (!gameState.profession) {
                    setTimeout(() => {
                        assignProfession();
                    }, 500);
                }
            }
            
            if (gameState.level >= 150) {
                achievementCards.master.classList.remove('locked');
                if (!gameState.level150Achieved) {
                    gameState.level150Achieved = true;
                    saveGame();
                }
            }
            
            if (gameState.status) {
                statusIndicator.textContent = gameState.status;
                statusIndicator.style.display = 'inline-block';
            }
            
            if (gameState.profession) {
                professionIndicator.textContent = gameState.profession;
                professionIndicator.style.display = 'inline-block';
            }
        }
        
        // Check if all quests are completed
        function checkAllQuestsCompleted() {
            const allCompleted = gameState.dailyQuests.every(quest => quest.completed);
            
            if (allCompleted) {
                // Увеличиваем счетчик дней подряд
                gameState.consecutiveDays++;
                
                // Проверяем достижения дисциплины
                const currentLevel = disciplineLevels[gameState.disciplineLevel];
                if (!currentLevel.max && gameState.consecutiveDays >= currentLevel.days) {
                    if (gameState.disciplineLevel < disciplineLevels.length - 1) {
                        gameState.disciplineLevel++;
                        
                        // Добавляем событие в ленту
                        addEvent(`🏆 Новый уровень дисциплины: ${disciplineLevels[gameState.disciplineLevel].name}`, 'success');
                        showNotification('🏆 Улучшение дисциплины!', `Вы достигли уровня: ${disciplineLevels[gameState.disciplineLevel].name}`, 'success');
                    }
                }
                
                // Показываем сообщение
                completedAll.style.display = 'block';
                saveGame();
                
                // Добавляем событие в ленту
                addEvent('🎯 Все квесты выполнены!', 'success');
                showNotification('🎯 Успех!', 'Все квесты за сегодня выполнены!', 'success');
            } else {
                // Сбрасываем счетчик дней подряд, если не все квесты выполнены
                if (gameState.consecutiveDays > 0) {
                    gameState.consecutiveDays = 0;
                    saveGame();
                    
                    // Добавляем событие в ленту
                    addEvent('⚠️ Серия дисциплины прервана', 'warning');
                    showNotification('⚠️ Внимание!', 'Серия дисциплины прервана', 'warning');
                }
            }
        }
        
        // Show status selection modal
        function showStatusModal() {
            statusModal.style.display = 'flex';
        }
        
        // Assign profession based on highest attribute
        function assignProfession() {
            let highestAttribute = 'strength';
            let highestValue = gameState.attributes.strength;
            
            Object.keys(gameState.attributes).forEach(attr => {
                if (gameState.attributes[attr] > highestValue) {
                    highestValue = gameState.attributes[attr];
                    highestAttribute = attr;
                }
            });
            
            let profession = '';
            switch (highestAttribute) {
                case 'strength': profession = 'Качок'; break;
                case 'agility': profession = 'Атлет'; break;
                case 'perception': profession = 'Мудрец'; break;
                case 'stamina': profession = 'Стайер'; break;
                case 'intelligence': profession = 'Интеллектуал'; break;
                default: profession = 'Эксперт';
            }
            
            gameState.profession = profession;
            saveGame();
            
            professionMessage.textContent = `Поздравляем! Вам присвоена профессия: ${profession}`;
            professionModal.style.display = 'flex';
            
            // Добавляем событие в ленту
            addEvent(`🎓 Получена профессия: ${profession}`, 'success');
            showNotification('🎓 Новая профессия!', `Вам присвоена профессия: ${profession}`, 'success');
        }
        
        // Add points to attribute
        function addPoints(attribute, points, questCard, questIndex, coinReward) {
            // Определяем множитель (2x в воскресенье)
            const multiplier = new Date().getDay() === 0 ? 2 : 1;
            let actualPoints = points * multiplier;
            
            // Применяем бонусы от сундуков
            actualPoints = Math.round(actualPoints * gameState.expMultiplier);
            
            // NEW: Для пользовательских квестов всегда даем +1 ко всем характеристикам
            if (gameState.dailyQuests[questIndex].custom) {
                actualPoints = 1;
                attribute = 'all';
            }
            
            // Добавляем очки к атрибуту
            if (attribute === 'all') {
                Object.keys(gameState.attributes).forEach(attr => {
                    gameState.attributes[attr] += actualPoints;
                    
                    // Ограничиваем максимальное значение
                    if (gameState.attributes[attr] > gameState.maxAttributeValue) {
                        gameState.attributes[attr] = gameState.maxAttributeValue;
                    }
                });
            } else {
                gameState.attributes[attribute] += actualPoints;
                
                // Ограничиваем максимальное значение
                if (gameState.attributes[attribute] > gameState.maxAttributeValue) {
                    gameState.attributes[attribute] = gameState.maxAttributeValue;
                }
            }
            
            gameState.totalPoints += actualPoints;
            gameState.currentPoints += actualPoints;
            
            // Добавляем монеты, если есть награда
            if (coinReward) {
                gameState.coins += 1;
                updateCoinsDisplay();
                
                // Анимация монеты
                animateCoin(questCard.querySelector('.quest-btn'));
                
                // Добавляем событие в ленту
                addEvent(`🪙 Получена монета за выполнение квеста`, 'info');
                showNotification('🪙 Монета получена!', 'За выполнение квеста', 'info');
            }
            
            // Помечаем квест как выполненный
            gameState.dailyQuests[questIndex].completed = true;
            
            // NEW: Если это пользовательский квест, помечаем его как выполненный в массиве customQuests
            if (gameState.dailyQuests[questIndex].custom) {
                const customQuestTitle = gameState.dailyQuests[questIndex].title;
                if (gameState.customQuests) {
                    const customQuest = gameState.customQuests.find(q => q.title === customQuestTitle && !q.completed);
                    if (customQuest) {
                        customQuest.completed = true;
                    }
                }
            }
            
            // Добавляем статистику за неделю
            if (attribute === 'all') {
                Object.keys(gameState.attributes).forEach(attr => {
                    gameState.weeklyStats[attr].points += actualPoints;
                });
            } else {
                gameState.weeklyStats[attribute].points += actualPoints;
                gameState.weeklyStats[attribute].actions.push(gameState.dailyQuests[questIndex].title);
            }
            
            saveGame();
            
            // Добавляем событие в ленту
            addEvent(`✅ Выполнен квест: "${gameState.dailyQuests[questIndex].title}"`, 'success');
            showNotification('✅ Квест выполнен!', `+${actualPoints} к ${getAttributeName(attribute)}`, 'success');
            
            // Проверяем, нужно ли повысить уровень
            while (gameState.currentPoints >= gameState.pointsToNextLevel) {
                gameState.currentPoints -= gameState.pointsToNextLevel;
                gameState.level++;
                
                // Пересчитываем требования для следующего уровня
                gameState.pointsToNextLevel = calculatePointsToNextLevel();
                
                // Анимация повышения уровня
                levelElement.classList.add('glowing');
                levelElement.style.animation = 'level-up 0.5s ease-in-out';
                setTimeout(() => {
                    levelElement.classList.remove('glowing');
                    levelElement.style.animation = '';
                }, 2000);
                
                // Добавляем событие в ленту
                addEvent(`🎉 Повышение уровня: ${gameState.level}`, 'success');
                showNotification('🎉 Уровень повышен!', `Поздравляем с достижением ${gameState.level} уровня!`, 'success');
            }
            
            // Animate quest card disappearance
            questCard.classList.add('completed');
            setTimeout(() => {
                questCard.remove();
            }, 500);
            
            // Scroll to attribute card with animation
            setTimeout(() => {
                attributeCards[attribute].scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Add highlight animation
                attributeCards[attribute].classList.add('highlight');
                setTimeout(() => {
                    attributeCards[attribute].classList.remove('highlight');
                }, 1500);
            }, 600);
            
            updateStats();
            saveGame();
            
            // Проверяем выполнение всех квестов
            checkAllQuestsCompleted();
        }
        
        // Complete weekly quest
        function completeWeeklyQuest() {
            // Add points to all attributes
            Object.keys(gameState.attributes).forEach(attr => {
                gameState.attributes[attr] += 2;
                
                // Ограничиваем максимальное значение
                if (gameState.attributes[attr] > gameState.maxAttributeValue) {
                    gameState.attributes[attr] = gameState.maxAttributeValue;
                }
            });
            
            gameState.totalPoints += 10;
            gameState.currentPoints += 10;
            gameState.weeklyQuest.completed = true;
            
            // Добавляем монеты
            gameState.coins += 3;
            updateCoinsDisplay();
            
            // Анимация монет
            animateCoin(weeklyQuestBtn);
            
            // Проверяем, нужно ли повысить уровень
            while (gameState.currentPoints >= gameState.pointsToNextLevel) {
                gameState.currentPoints -= gameState.pointsToNextLevel;
                gameState.level++;
                
                // Пересчитываем требования для следующего уровня
                gameState.pointsToNextLevel = calculatePointsToNextLevel();
            }
            
            weeklyQuestBtn.textContent = 'Выполнено!';
            weeklyQuestBtn.classList.add('completed');
            
            saveGame();
            updateStats();
            
            // Add animation
            weeklyQuestCard.classList.add('glowing');
            setTimeout(() => {
                weeklyQuestCard.classList.remove('glowing');
            }, 2000);
            
            // Добавляем событие в ленту
            addEvent(`🌟 Выполнен еженедельный квест: "${gameState.weeklyQuest.title}"`, 'success');
            showNotification('🌟 Успех!', 'Еженедельный квест выполнен!', 'success');
        }
        
        // Show quest confirmation modal
        function showQuestConfirmation(questIndex) {
            const quest = gameState.dailyQuests[questIndex];
            confirmQuestMessage.textContent = `Вы подтверждаете, что завершили квест "${quest.title}"?`;
            gameState.currentQuestIndex = questIndex;
            confirmQuestModal.style.display = 'flex';
        }
        
        // Show attribute description modal
        function showAttributeModal(attribute) {
            attributeModalTitle.textContent = attributeCards[attribute].querySelector('.attribute-name').textContent;
            attributeModalDesc.textContent = attributeDescriptions[attribute];
            attributeModal.style.display = 'flex';
        }
        
        // NEW: Show rules modal (заменяет достижение Дисциплина)
        function showRulesModal() {
            rulesModal.style.display = 'flex';
        }
        
        // Show achievement info modal
        function showAchievementInfo(type) {
            let title = '';
            let description = '';
            
            switch(type) {
                case 'status':
                    title = 'Статус';
                    if (gameState.level < 50) {
                        description = `Необходимо достигнуть 50 уровня, чтобы открыть статус. Текущий уровень: ${gameState.level}`;
                    } else {
                        description = 'Выберите свой уникальный статус, который будет отражать ваш путь развития.';
                    }
                    break;
                    
                case 'profession':
                    title = 'Профессия';
                    if (gameState.level < 75) {
                        description = `Необходимо достигнуть 75 уровня, чтобы выбрать профессию. Текущий уровень: ${gameState.level}`;
                    } else {
                        description = 'Выберите профессию, которая определит вашу дальнейшую специализацию.';
                    }
                    break;
                    
                case 'master':
                    title = 'Мастер всех стихий';
                    if (gameState.level < 150) {
                        description = `Необходимо достигнуть 150 уровня, чтобы получить это достижение. Текущий уровень: ${gameState.level}`;
                    } else {
                        description = 'Человек, который совершил невозможное!';
                    }
                    break;
            }
            
            achievementModalTitle.textContent = title;
            achievementModalDesc.textContent = description;
            achievementModal.style.display = 'flex';
        }
        
        // Show shop item modal
        function showShopItemModal(type) {
            shopItemTitle.textContent = document.querySelector(`.shop-item.${type} .shop-title`).textContent;
            shopItemContent.textContent = `Внутри: ${chestDescriptions[type]}`;
            shopItemPrice.textContent = document.querySelector(`.shop-item.${type} .shop-price span`).textContent;
            shopItemPrice.dataset.type = type;
            shopItemModal.style.display = 'flex';
        }
        
        // Buy shop item
        function buyShopItem(type) {
            const price = parseInt(document.querySelector(`.shop-item.${type} .shop-price span`).textContent);
            
            if (gameState.coins >= price) {
                gameState.coins -= price;
                gameState.chestsBought.push(type);
                
                // Apply chest bonuses
                switch(type) {
                    case 'common':
                        // +3 ко всем характеристикам
                        Object.keys(gameState.attributes).forEach(attr => {
                            gameState.attributes[attr] += 3;
                        });
                        // +1 замена в день
                        gameState.maxReplaceCount += 1;
                        gameState.replaceCount = gameState.maxReplaceCount;
                        break;
                        
                    case 'rare':
                        // +5 ко всем характеристикам
                        Object.keys(gameState.attributes).forEach(attr => {
                            gameState.attributes[attr] += 5;
                        });
                        // +100% к улучшениям на 48 часов
                        const rareBonus = {
                            multiplier: 1.0,
                            expires: Date.now() + 48 * 60 * 60 * 1000
                        };
                        gameState.tempBonuses.push(rareBonus);
                        // +1 ежедневный квест
                        gameState.maxDailyQuests += 1;
                        // +1 замена в день
                        gameState.maxReplaceCount += 1;
                        gameState.replaceCount = gameState.maxReplaceCount;
                        break;
                        
                    case 'epic':
                        // +50 к случайному атрибуту
                        const attributes = Object.keys(gameState.attributes);
                        const randomAttr = attributes[Math.floor(Math.random() * attributes.length)];
                        gameState.attributes[randomAttr] += 50;
                        // +1 ежедневный квест
                        gameState.maxDailyQuests += 1;
                        // +2 замены в день
                        gameState.maxReplaceCount += 2;
                        gameState.replaceCount = gameState.maxReplaceCount;
                        // Отмена обязательного квеста
                        gameState.noMandatoryPenalty = true;
                        // +150% к улучшениям на 72 часа
                        const epicBonus = {
                            multiplier: 1.5,
                            expires: Date.now() + 72 * 60 * 60 * 1000
                        };
                        gameState.tempBonuses.push(epicBonus);
                        break;
                        
                    case 'legendary':
                        // +200% к улучшениям навсегда
                        gameState.expMultiplier += 2.0;
                        // Отмена наказания за обязательный квест
                        gameState.noMandatoryPenalty = true;
                        // +2 ежедневных квеста
                        gameState.maxDailyQuests += 2;
                        // Неограниченные замены
                        gameState.maxReplaceCount = Infinity;
                        gameState.replaceCount = Infinity;
                        break;
                }
                
                // Удаляем купленный сундук из магазина
                document.querySelector(`.shop-item.${type}`).remove();
                
                updateCoinsDisplay();
                saveGame();
                updateStats();
                generateDailyQuests(); // Regenerate quests with new count
                
                shopItemModal.style.display = 'none';
                
                // Анимация открытия сундука
                const chestIcon = document.querySelector(`.shop-item.${type} .chest-icon i`);
                if (chestIcon) {
                    chestIcon.classList.add('chest-opening');
                    setTimeout(() => {
                        chestIcon.classList.remove('chest-opening');
                    }, 500);
                }
                
                // Добавляем событие в ленту
                addEvent(`🎁 Куплен ${type} сундук`, 'info');
                showNotification('🎁 Сундук куплен!', `Вы получили: ${chestDescriptions[type]}`, 'success');
            } else {
                alert(`У вас недостаточно монет L для этой покупки. Требуется: ${price}, у вас: ${gameState.coins}`);
            }
        }
        
        // Show level info modal
        function showLevelInfo() {
            const pointsLeft = gameState.pointsToNextLevel - gameState.currentPoints;
            levelInfoContent.textContent = `До следующего уровня осталось: ${pointsLeft} очков опыта`;
            levelInfoModal.style.display = 'flex';
        }
        
        // NEW: Show notification
        function showNotification(title, content, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-title">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
                    ${title}
                </div>
                <div class="notification-content">${content}</div>
            `;
            
            notificationsContainer.appendChild(notification);
            
            // Remove notification after animation
            setTimeout(() => {
                notification.remove();
            }, 3500);
        }
        
        // NEW: Add event to feed
        function addEvent(content, type = 'info') {
            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const event = {
                content: content,
                type: type,
                timestamp: now.getTime()
            };
            
            gameState.events.unshift(event);
            if (gameState.events.length > 20) {
                gameState.events.pop();
            }
            
            saveGame();
            renderEvents();
        }
        
        // NEW: Render events to feed
        function renderEvents() {
            eventsList.innerHTML = '';
            
            gameState.events.forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.className = `event-item ${event.type}`;
                
                const now = new Date();
                const time = new Date(event.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                eventItem.innerHTML = `
                    <div class="event-icon">
                        <i class="fas fa-${event.type === 'success' ? 'check' : event.type === 'warning' ? 'exclamation' : event.type === 'danger' ? 'times' : 'info'}"></i>
                    </div>
                    <div class="event-content">${event.content}</div>
                    <div class="event-time">${time}</div>
                `;
                
                eventsList.appendChild(eventItem);
            });
        }
        
        // NEW: Animate coin
        function animateCoin(startElement) {
            const coin = document.createElement('div');
            coin.innerHTML = '🪙';
            coin.style.position = 'fixed';
            coin.style.zIndex = '1000';
            coin.style.fontSize = '20px';
            
            // Get start position
            const startRect = startElement.getBoundingClientRect();
            const startX = startRect.left + startRect.width / 2;
            const startY = startRect.top + startRect.height / 2;
            
            // Get end position
            const walletRect = walletElement.getBoundingClientRect();
            const endX = walletRect.left + walletRect.width / 2;
            const endY = walletRect.top + walletRect.height / 2;
            
            // Calculate distance
            const deltaX = endX - startX;
            const deltaY = endY - startY;
            
            // Set initial position
            coin.style.left = `${startX}px`;
            coin.style.top = `${startY}px`;
            coin.style.transform = 'translate(-50%, -50%)';
            document.body.appendChild(coin);
            
            // Set CSS variables for animation
            coin.style.setProperty('--tx', `${deltaX}px`);
            coin.style.setProperty('--ty', `${deltaY}px`);
            
            // Animate
            coin.style.animation = 'fly-coin 1s forwards';
            
            // Remove coin after animation
            setTimeout(() => {
                coin.remove();
            }, 1000);
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Кнопка "Начать прокачку" прокручивает к квестам
            startButton.addEventListener('click', function() {
                this.classList.add('active');
                setTimeout(() => {
                    this.classList.remove('active');
                    questsSection.scrollIntoView({ behavior: 'smooth' });
                }, 300);
            });
            
            // Переключатель темы
            themeToggle.addEventListener('click', toggleTheme);
            
            // Добавляем обработчики событий для кнопок квестов
            document.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('quest-btn') && !e.target.classList.contains('completed')) {
                    const button = e.target;
                    const questIndex = parseInt(button.dataset.index);
                    showQuestConfirmation(questIndex);
                }
            });
            
            // Кнопка замены квеста
            replaceQuestBtn.addEventListener('click', showReplaceConfirmModal);
            
            // NEW: Кнопка добавления своего квеста
            addCustomQuestBtn.addEventListener('click', showCustomQuestModal);
            
            // Кнопка подтверждения замены
            confirmReplaceBtn.addEventListener('click', activateReplaceMode);
            
            // Кнопка отмены замены
            cancelReplaceBtn.addEventListener('click', hideReplaceConfirmModal);
            
            // NEW: Кнопка сохранения пользовательского квеста
            saveCustomQuestBtn.addEventListener('click', saveCustomQuest);
            
            // NEW: Кнопка отмены создания пользовательского квеста
            cancelCustomQuestBtn.addEventListener('click', hideCustomQuestModal);
            
            // Кнопка выполнения еженедельного квеста
            weeklyQuestBtn.addEventListener('click', function() {
                if (!gameState.weeklyQuest.completed) {
                    showWeeklyConfirmModal();
                }
            });
            
            // NEW: Кнопка подтверждения еженедельного квеста
            confirmWeeklyBtn.addEventListener('click', function() {
                hideWeeklyConfirmModal();
                completeWeeklyQuest();
            });
            
            // NEW: Кнопка отмены еженедельного квеста
            cancelWeeklyBtn.addEventListener('click', hideWeeklyConfirmModal);
            
            // Модальное окно статуса
            document.querySelectorAll('.modal-option[data-status]').forEach(option => {
                option.addEventListener('click', function() {
                    gameState.status = this.dataset.status;
                    statusIndicator.textContent = gameState.status;
                    statusIndicator.style.display = 'inline-block';
                    statusModal.style.display = 'none';
                    saveGame();
                    
                    // Добавляем событие в ленту
                    addEvent(`🏷️ Установлен статус: ${gameState.status}`, 'info');
                    showNotification('🏷️ Новый статус!', `Вы выбрали: ${gameState.status}`, 'info');
                });
            });
            
            // Модальное окно профессии
            document.getElementById('close-profession-modal').addEventListener('click', function() {
                professionModal.style.display = 'none';
            });
            
            // Модальное окно наказания
            document.getElementById('close-punishment-modal').addEventListener('click', function() {
                punishmentModal.style.display = 'none';
            });
            
            // Кнопки закрытия модальных окон
            document.querySelectorAll('.modal-close').forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    modal.style.display = 'none';
                });
            });
            
            // Подтверждение выполнения квеста
            confirmQuestBtn.addEventListener('click', function() {
                const questIndex = gameState.currentQuestIndex;
                const questCard = document.querySelector(`.quest-card[data-index="${questIndex}"]`);
                const button = questCard.querySelector('.quest-btn');
                const attribute = button.dataset.attribute;
                const points = parseInt(button.dataset.points);
                const coinReward = button.dataset.coin === 'true';
                
                // Закрываем модальное окно
                confirmQuestModal.style.display = 'none';
                
                // Помечаем как выполненный
                button.textContent = 'Выполнено!';
                button.classList.add('completed');
                
                // Добавляем очки и прокручиваем к атрибуту
                addPoints(attribute, points, questCard, questIndex, coinReward);
            });
            
            // Отмена выполнения квеста
            cancelQuestBtn.addEventListener('click', function() {
                confirmQuestModal.style.display = 'none';
            });
            
            // Показать описание характеристики при клике
            Object.keys(attributeCards).forEach(attr => {
                attributeCards[attr].addEventListener('click', function() {
                    showAttributeModal(attr);
                });
            });
            
            // Закрыть модальное окно характеристики
            document.getElementById('close-attribute-modal').addEventListener('click', function() {
                attributeModal.style.display = 'none';
            });
            
            // NEW: Показать правила прокачки при клике
            achievementCards.rules.addEventListener('click', function() {
                showRulesModal();
            });
            
            // NEW: Закрыть модальное окно правил
            closeRulesBtn.addEventListener('click', function() {
                rulesModal.style.display = 'none';
            });
            
            // Показать информацию о достижении при клике
            achievementCards.status.addEventListener('click', function() {
                showAchievementInfo('status');
            });
            
            achievementCards.profession.addEventListener('click', function() {
                showAchievementInfo('profession');
            });
            
            achievementCards.master.addEventListener('click', function() {
                showAchievementInfo('master');
            });
            
            // Закрыть модальное окно достижения
            document.getElementById('close-achievement-modal').addEventListener('click', function() {
                achievementModal.style.display = 'none';
            });
            
            // Кнопки магазина
            document.querySelectorAll('.shop-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const shopItem = this.closest('.shop-item');
                    const type = shopItem.dataset.type;
                    showShopItemModal(type);
                });
            });
            
            // Подтверждение покупки в магазине
            confirmBuyBtn.addEventListener('click', function() {
                const type = shopItemPrice.dataset.type;
                buyShopItem(type);
            });
            
            // Отмена покупки в магазине
            cancelBuyBtn.addEventListener('click', function() {
                shopItemModal.style.display = 'none';
            });
            
            // Клик по кошельку - переход в магазин
            walletElement.addEventListener('click', function() {
                document.getElementById('shop-section').scrollIntoView({ behavior: 'smooth' });
            });
            
            // Клик по уровню или прогресс бару - показать информацию
            levelContainer.addEventListener('click', showLevelInfo);
            levelProgressContainer.addEventListener('click', showLevelInfo);
            
            // Закрыть модальное окно уровня
            document.getElementById('close-level-modal').addEventListener('click', function() {
                levelInfoModal.style.display = 'none';
            });
            
            // Клик по сундуку для просмотра информации
            document.querySelectorAll('.shop-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // Если клик не по кнопке - открываем информацию
                    if (!e.target.classList.contains('shop-btn')) {
                        const type = this.dataset.type;
                        showShopItemModal(type);
                        
                        // Анимация открытия сундука
                        const chest = this.querySelector('.chest-icon i');
                        if (chest) {
                            chest.classList.add('chest-opening');
                            setTimeout(() => {
                                chest.classList.remove('chest-opening');
                            }, 500);
                        }
                    }
                });
            });
            
            // Закрываем модальные окна при клике снаружи
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }
        
        // Timer for quest reset
        function startTimers() {
            // Daily timer
            const dailyTimer = setInterval(() => {
                const now = Date.now();
                const timeLeft = gameState.questResetTime - now;
                
                if (timeLeft < 0) {
                    checkMandatoryQuest();
                    resetQuests();
                    setQuestResetTime();
                    generateDailyQuests();
                    completedAll.style.display = 'none';
                }
                
                const seconds = Math.floor(timeLeft / 1000);
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
            
            // Weekly timer
            const weeklyTimer = setInterval(() => {
                const now = Date.now();
                const timeLeft = gameState.weeklyResetTime - now;
                
                if (timeLeft < 0) {
                    showWeeklyReport();
                    resetWeeklyQuest();
                    setWeeklyResetTime();
                }
                
                const seconds = Math.floor(timeLeft / 1000);
                const days = Math.floor(seconds / 86400);
                const hours = Math.floor((seconds % 86400) / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                weeklyTimerElement.textContent = `${days}д ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // Reset quests
        function resetQuests() {
            gameState.dailyQuests = [];
            gameState.replaceCount = gameState.maxReplaceCount;
            gameState.mandatoryQuestIndex = -1;
            generateDailyQuests();
            saveGame();
            
            // Добавляем событие в ленту
            addEvent('🔄 Обновлены ежедневные квесты', 'info');
            showNotification('🔄 Обновление!', 'Появились новые ежедневные квесты', 'info');
        }
        
        // Initialize the game when page loads
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>